<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cochin Aquatics Management System v2.0 - Multi-User</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        /* Authentication Styles */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            text-align: center;
        }

        .auth-title {
            color: #1e3c72;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .auth-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .auth-input {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .auth-input:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .auth-btn {
            padding: 15px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
        }

        .auth-toggle {
            margin-top: 20px;
            color: #666;
            cursor: pointer;
        }

        .auth-toggle span {
            color: #1e3c72;
            font-weight: 600;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .user-info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 14px;
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 15px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
        }

        .version-badge {
            position: absolute;
            top: 20px;
            right: 80px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            color: #1e3c72;
            border-bottom: 3px solid #1e3c72;
            background: white;
        }

        .content {
            padding: 20px;
            min-height: 400px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .period-selector {
            display: inline-flex;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .period-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .period-btn.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: #1e3c72;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input[type="date"] {
            cursor: pointer;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 239, 125, 0.4);
        }

        .btn-add {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            margin-top: 10px;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .fish-entry {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
        }

        .fish-entry h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .fish-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .pond-distribution {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .pond-distribution-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .pond-distribution-item select,
        .pond-distribution-item input {
            flex: 1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-card.success {
            border-left-color: #38ef7d;
        }

        .stat-card.danger {
            border-left-color: #f5576c;
        }

        .stat-card.warning {
            border-left-color: #ffa726;
        }

        .stat-card.info {
            border-left-color: #42a5f5;
        }

        .transaction-list {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .transaction-item {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .transaction-item:hover {
            background: #f8f9fa;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-type {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .type-purchase {
            background: #e3f2fd;
            color: #1976d2;
        }

        .type-sale {
            background: #e8f5e9;
            color: #388e3c;
        }

        .type-trading {
            background: #fff3e0;
            color: #f57c00;
        }

        .type-expense {
            background: #ffebee;
            color: #c62828;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #2c3e50;
        }

        .close-modal {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }

        .close-modal:hover {
            color: #2c3e50;
        }

        .pond-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .pond-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
            position: relative;
        }

        .pond-card:hover {
            transform: scale(1.05);
        }

        .pond-card h3 {
            margin-bottom: 10px;
        }

        .pond-card .count {
            font-size: 24px;
            font-weight: bold;
        }

        .pond-card .fish-types {
            margin-top: 10px;
            font-size: 12px;
            opacity: 0.9;
        }

        .edit-pond-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.3);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            color: white;
        }

        .success-message {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .success-message.show {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .total-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }

        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #1976d2;
        }

        .info-box h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .add-category-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .add-category-input input {
            flex: 1;
        }

        .add-category-input button {
            padding: 8px 16px;
        }

        .list-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .list-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .list-item:hover {
            background: #f8f9fa;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                flex-shrink: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .row {
                grid-template-columns: 1fr;
            }

            .user-info, .logout-btn, .version-badge {
                position: static;
                display: inline-block;
                margin: 5px;
            }

            .header {
                text-align: left;
                padding-bottom: 15px;
            }

            .content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div id="authContainer" class="auth-container">
        <h2 class="auth-title">Cochin Aquatics</h2>
        <p class="auth-subtitle">Sign in to access your business management system</p>
        <div id="authForm" class="auth-form">
            <input type="email" id="authEmail" class="auth-input" placeholder="Email Address" required>
            <input type="password" id="authPassword" class="auth-input" placeholder="Password" required>
            <button id="authSubmit" class="auth-btn">Sign In</button>
            <div class="auth-toggle" id="toggleAuth">
                Don't have an account? <span>Sign Up</span>
            </div>
        </div>
        <div class="error-message" id="authError"></div>
        <div id="authLoading" style="display: none; margin-top: 15px; color: #1e3c72;">
            Processing...
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="appContainer" class="container" style="display: none;">
        <div class="header">
            <div class="user-info" id="userInfo">
                <span id="userEmail"></span>
            </div>
            <button id="logoutBtn" class="logout-btn">Logout</button>
            <div class="version-badge">v2.0</div>
            <h1>Cochin Aquatics Management System</h1>
            <div class="subtitle">Multi-User • Real-Time • Cloud-Powered</div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="dashboard">Dashboard</button>
            <button class="tab" data-tab="transaction">New Transaction</button>
            <button class="tab" data-tab="expense">Add Expense</button>
            <button class="tab" data-tab="ponds">Ponds</button>
            <button class="tab" data-tab="reports">Reports</button>
            <button class="tab" data-tab="settings">Settings</button>
        </div>

        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">Financial Overview</h2>
                
                <div class="period-selector">
                    <button class="period-btn active" data-period="today">Today</button>
                    <button class="period-btn" data-period="week">This Week</button>
                    <button class="period-btn" data-period="month">This Month</button>
                    <button class="period-btn" data-period="year">This Year</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card success">
                        <h3><span id="periodLabel">Today's</span> Income</h3>
                        <div class="value" id="periodIncome">₹0</div>
                    </div>
                    <div class="stat-card danger">
                        <h3><span id="periodLabelExpense">Today's</span> Expense</h3>
                        <div class="value" id="periodExpense">₹0</div>
                    </div>
                    <div class="stat-card info">
                        <h3><span id="periodLabelProfit">Today's</span> Profit</h3>
                        <div class="value" id="periodProfit">₹0</div>
                    </div>
                    <div class="stat-card warning">
                        <h3>Active Ponds</h3>
                        <div class="value" id="activePonds">0</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 15px; color: #2c3e50;">Recent Transactions</h3>
                <div class="transaction-list" id="recentTransactions">
                    <div class="empty-state">
                        <div class="icon">📋</div>
                        <h3>No transactions yet</h3>
                        <p>Start by adding a new transaction!</p>
                    </div>
                </div>
            </div>

            <!-- Transaction Tab -->
            <div id="transaction" class="tab-content">
                <div class="success-message" id="transactionSuccess">
                    Transaction added successfully!
                </div>

                <form id="transactionForm">
                    <div class="row">
                        <div class="form-group">
                            <label>Transaction Date</label>
                            <input type="date" id="transactionDate" required>
                        </div>
                        <div class="form-group">
                            <label>Transaction Type</label>
                            <select id="transactionType" required>
                                <option value="">Select Type</option>
                                <option value="purchase">Purchase (Buying Fish)</option>
                                <option value="sale">Sale (Selling Fish)</option>
                                <option value="trading">Trading (Buy & Sell)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="personLabel">Vendor/Customer Name</label>
                        <select id="personName" required>
                            <option value="">Select or Add New</option>
                        </select>
                        <input type="text" id="newPersonName" placeholder="Or type new name here..." style="margin-top: 10px;">
                    </div>

                    <div id="fishEntries">
                        <div class="fish-entry">
                            <h4>
                                <span><span class="fish-icon">🐟</span> Fish Details #1</span>
                            </h4>
                            <div class="row">
                                <div class="form-group">
                                    <label>Fish Type</label>
                                    <select class="fish-type" required>
                                        <option value="">Select Fish</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Quantity</label>
                                    <input type="number" class="fish-quantity" placeholder="e.g., 1000" required>
                                </div>
                                <div class="form-group">
                                    <label class="rate-label">Rate per Fish (₹)</label>
                                    <input type="number" step="0.01" class="fish-rate" placeholder="e.g., 1.5" required>
                                </div>
                                <div class="form-group trading-field" style="display: none;">
                                    <label>Buy Rate (₹)</label>
                                    <input type="number" step="0.01" class="fish-buy-rate" placeholder="e.g., 1.2">
                                </div>
                            </div>
                            <div class="pond-section">
                                <label class="pond-label">Assign to Pond</label>
                                <div class="pond-distribution" id="pondDist1">
                                    <div class="pond-distribution-item">
                                        <select class="pond-select">
                                            <option value="">Select Pond</option>
                                        </select>
                                        <input type="number" class="pond-quantity" placeholder="Quantity">
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm" onclick="addPondDistribution(1)" style="padding: 5px 10px; font-size: 12px;">+ Add Another Pond</button>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-add" onclick="addFishEntry()">Add More Fish</button>

                    <div class="form-group" style="margin-top: 20px;">
                        <div class="total-display">
                            Total Amount: ₹<span id="totalAmount">0</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="transactionNotes" rows="3" placeholder="Any additional details..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Save Transaction
                    </button>
                </form>
            </div>

            <!-- Expense Tab -->
            <div id="expense" class="tab-content">
                <div class="success-message" id="expenseSuccess">
                    Expense added successfully!
                </div>

                <form id="expenseForm">
                    <div class="row">
                        <div class="form-group">
                            <label>Expense Date</label>
                            <input type="date" id="expenseDate" required>
                        </div>
                        <div class="form-group">
                            <label>Expense Type</label>
                            <select id="expenseType" required>
                                <option value="">Select Type</option>
                                <option value="pond">Pond Specific Expense</option>
                                <option value="general">General Farm Expense</option>
                                <option value="salary">Employee Salary</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="pondSelectDiv" style="display: none;">
                        <label>Select Pond</label>
                        <select id="expensePond">
                            <option value="">Select Pond</option>
                        </select>
                    </div>

                    <div class="form-group" id="employeeDiv" style="display: none;">
                        <label>Employee Name</label>
                        <input type="text" id="employeeName" placeholder="Enter employee name">
                    </div>

                    <div class="form-group">
                        <label>Expense Category</label>
                        <select id="expenseCategory" required>
                            <option value="">Select Category</option>
                        </select>
                        <div class="add-category-input" style="display: none;" id="newCategoryDiv">
                            <input type="text" id="newCategoryInput" placeholder="Enter new category name">
                            <button type="button" class="btn btn-success" onclick="addNewCategory()">Add</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Amount (₹)</label>
                        <input type="number" id="expenseAmount" placeholder="Enter amount" required>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="expenseDescription" rows="3" placeholder="Describe the expense..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Save Expense
                    </button>
                </form>
            </div>

            <!-- Ponds Tab -->
            <div id="ponds" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">Pond Management</h2>
                
                <div class="button-group">
                    <button class="btn btn-success" onclick="showAddPondModal()">Add New Pond</button>
                    <button class="btn btn-warning" onclick="showAdjustStockModal()">Adjust Fish Stock</button>
                </div>

                <div class="pond-grid" id="pondGrid">
                    <!-- Ponds will be loaded here -->
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">Reports & Analytics</h2>
                
                <div class="period-selector">
                    <button class="period-btn active" data-period="month">Monthly</button>
                    <button class="period-btn" data-period="quarter">Quarterly</button>
                    <button class="period-btn" data-period="year">Yearly</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3><span id="reportPeriodLabel">This Month</span> Income</h3>
                        <div class="value" id="reportIncome">₹0</div>
                    </div>
                    <div class="stat-card">
                        <h3><span id="reportPeriodLabelExpense">This Month</span> Expense</h3>
                        <div class="value" id="reportExpense">₹0</div>
                    </div>
                    <div class="stat-card success">
                        <h3><span id="reportPeriodLabelProfit">This Month</span> Profit</h3>
                        <div class="value" id="reportProfit">₹0</div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">Pond-wise Profitability</h3>
                    <div id="pondProfitReport">
                        <!-- Pond profit data will be loaded here -->
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="exportData()">Export All Data (JSON)</button>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">Settings & Configuration</h2>
                
                <div class="form-section">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">Manage Fish Types</h3>
                    <div class="form-group">
                        <label>Add New Fish Type</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="newFishType" placeholder="Enter fish name">
                            <button class="btn btn-success" onclick="addFishType()">Add</button>
                        </div>
                    </div>
                    <div id="fishTypesList" class="list-container">
                        <!-- Fish types will be listed here -->
                    </div>
                </div>

                <div class="form-section">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">Manage Customers & Vendors</h3>
                    <div class="form-group">
                        <label>Add New Person</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="newPersonInput" placeholder="Enter name">
                            <select id="personType">
                                <option value="customer">Customer</option>
                                <option value="vendor">Vendor</option>
                                <option value="both">Both</option>
                            </select>
                            <button class="btn btn-success" onclick="addPerson()">Add</button>
                        </div>
                    </div>
                    <div id="peopleList" class="list-container">
                        <!-- People will be listed here -->
                    </div>
                </div>

                <div class="form-section" style="background: #ffebee;">
                    <h3 style="margin-bottom: 15px; color: #c62828;">Data Management</h3>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="backupData()">Backup Data</button>
                        <button class="btn" style="background: #6c757d; color: white;" onclick="restoreData()">Restore Data</button>
                        <button class="btn" style="background: #dc3545; color: white;" onclick="clearAllData()">Clear All Data</button>
                    </div>
                    <div class="info-box" style="margin-top: 20px; background: #fff3e0; border-color: #f57c00;">
                        <h4 style="color: #f57c00;">Data Storage Info</h4>
                        <p style="font-size: 14px;">Your data is stored securely in the cloud and synced in real-time across all your devices.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Pond Modal -->
    <div id="addPondModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('addPondModal')">&times;</span>
                <h2>Add New Pond</h2>
            </div>
            <form id="addPondForm">
                <div class="form-group">
                    <label>Pond Name</label>
                    <input type="text" id="pondName" placeholder="e.g., Pond 1" required>
                </div>
                <div class="form-group">
                    <label>Capacity (Maximum Fish)</label>
                    <input type="number" id="pondCapacity" placeholder="e.g., 10000" required>
                </div>
                <div class="form-group">
                    <label>Primary Fish Type</label>
                    <select id="pondFishType">
                        <option value="">Select Fish Type</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Pond</button>
            </form>
        </div>
    </div>

    <!-- Adjust Stock Modal -->
    <div id="adjustStockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('adjustStockModal')">&times;</span>
                <h2>Adjust Fish Stock</h2>
            </div>
            <form id="adjustStockForm">
                <div class="form-group">
                    <label>Select Pond</label>
                    <select id="adjustPond" required>
                        <option value="">Select Pond</option>
                    </select>
                </div>
                <div id="currentStockInfo" style="display: none;">
                    <div class="info-box">
                        <h4>Current Stock</h4>
                        <div id="stockDetails"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Adjustment Type</label>
                    <select id="adjustmentType" required>
                        <option value="">Select Type</option>
                        <option value="mortality">Mortality (Death)</option>
                        <option value="growth">Growth Adjustment</option>
                        <option value="correction">Manual Correction</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fish Type</label>
                    <select id="adjustFishType" required>
                        <option value="">Select Fish</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity Change</label>
                    <input type="number" id="adjustQuantity" placeholder="Enter positive or negative number" required>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="adjustNotes" rows="3" placeholder="Reason for adjustment..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Adjustment</button>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyASiFSwx9XWnwqRu07YVCmvJ8Txg-t_eLY",
            authDomain: "cochin-aquatics-manageme-bf543.firebaseapp.com",
            databaseURL: "https://cochin-aquatics-manageme-bf543-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cochin-aquatics-manageme-bf543",
            storageBucket: "cochin-aquatics-manageme-bf543.firebasestorage.app",
            messagingSenderId: "625465354366",
            appId: "1:625465354366:web:4985c0c7e5daf4405f102f",
            measurementId: "G-WYTZ6G2XN0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        console.log('Firebase initialized successfully!');

        // App Data Structure
        let appData = {
            transactions: [],
            expenses: [],
            ponds: [],
            stockAdjustments: [],
            fishTypes: ['Gold Fish', 'Angel Fish', 'Black Moors', 'Carp', 'Tetra', 'Guppy', 'Koi', 'Molly', 'Platy', 'Swordtail'],
            expenseCategories: ['Cleaning', 'Feed', 'Medicine', 'Electricity', 'Maintenance', 'Transport', 'Salary', 'Water Treatment', 'Equipment', 'Other'],
            people: [],
            nextTransactionId: 1,
            nextExpenseId: 1,
            nextPondId: 1,
            nextAdjustmentId: 1,
            currentDashboardPeriod: 'today',
            currentReportPeriod: 'month'
        };

        let currentUser = null;
        let isAuthenticated = false;
        let fishEntryCount = 1;

        // Helper Functions
        function safeNumber(value) {
            const num = parseFloat(value);
            return isNaN(num) ? 0 : num;
        }

        function formatMoney(amount) {
            const num = safeNumber(amount);
            return '₹' + num.toLocaleString('en-IN', { maximumFractionDigits: 2 });
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            if (el) {
                el.textContent = message;
                el.classList.add('show');
                setTimeout(() => el.classList.remove('show'), 3000);
            }
        }

        function showError(message) {
            const el = document.getElementById('authError');
            if (el) {
                el.textContent = message;
                el.style.display = 'block';
                setTimeout(() => el.style.display = 'none', 5000);
            }
        }

        // Authentication Functions
        function initializeAuth() {
            console.log('Initializing Firebase Authentication...');
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('User authenticated:', user.email);
                    currentUser = user;
                    isAuthenticated = true;
                    showMainApp();
                    await loadUserData();
                } else {
                    console.log('User not authenticated');
                    currentUser = null;
                    isAuthenticated = false;
                    showAuthForm();
                }
            });

            setupAuthForm();
        }

        function showMainApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('userEmail').textContent = currentUser.email;
            updateAllDisplays();
        }

        function showAuthForm() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('appContainer').style.display = 'none';
        }

        function setupAuthForm() {
            const authSubmit = document.getElementById('authSubmit');
            const authEmail = document.getElementById('authEmail');
            const authPassword = document.getElementById('authPassword');
            const toggleAuth = document.getElementById('toggleAuth');
            const authError = document.getElementById('authError');
            const authLoading = document.getElementById('authLoading');
            
            let isSignUp = false;

            toggleAuth.addEventListener('click', () => {
                isSignUp = !isSignUp;
                if (isSignUp) {
                    authSubmit.textContent = 'Sign Up';
                    toggleAuth.innerHTML = 'Already have an account? <span>Sign In</span>';
                } else {
                    authSubmit.textContent = 'Sign In';
                    toggleAuth.innerHTML = "Don't have an account? <span>Sign Up</span>";
                }
                hideAuthError();
            });

            authSubmit.addEventListener('click', async (e) => {
                e.preventDefault();
                
                const email = authEmail.value.trim();
                const password = authPassword.value;
                
                if (!email || !password) {
                    showAuthError('Please enter both email and password.');
                    return;
                }

                showAuthLoading(true);
                hideAuthError();

                try {
                    if (isSignUp) {
                        await auth.createUserWithEmailAndPassword(email, password);
                        console.log('User created successfully');
                        await initializeUserData();
                    } else {
                        await auth.signInWithEmailAndPassword(email, password);
                        console.log('User signed in successfully');
                    }
                } catch (error) {
                    console.error('Authentication error:', error);
                    showAuthError(getAuthErrorMessage(error.code));
                } finally {
                    showAuthLoading(false);
                }
            });

            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    await auth.signOut();
                    console.log('User signed out');
                } catch (error) {
                    console.error('Logout error:', error);
                }
            });
        }

        function showAuthError(message) {
            const authError = document.getElementById('authError');
            authError.textContent = message;
            authError.style.display = 'block';
        }

        function hideAuthError() {
            document.getElementById('authError').style.display = 'none';
        }

        function showAuthLoading(show) {
            document.getElementById('authLoading').style.display = show ? 'block' : 'none';
        }

        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/user-not-found':
                    return 'No account found with this email address.';
                case 'auth/wrong-password':
                    return 'Incorrect password.';
                case 'auth/email-already-in-use':
                    return 'An account with this email already exists.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters.';
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                default:
                    return 'Authentication failed. Please try again.';
            }
        }

        // Database Functions
        function getUserDataRef() {
            return database.ref(`users/${currentUser.uid}/aquaticsData`);
        }

        async function initializeUserData() {
            console.log('Initializing user data...');
            const userRef = getUserDataRef();
            
            const defaultData = {
                ...appData,
                ponds: [
                    {id: 1, name: 'Pond 1', capacity: 10000, primaryFishType: 'Gold Fish'},
                    {id: 2, name: 'Pond 2', capacity: 8000, primaryFishType: 'Angel Fish'},
                    {id: 3, name: 'Pond 3', capacity: 12000, primaryFishType: 'Carp'}
                ],
                people: [
                    {name: 'Arjun', type: 'vendor'},
                    {name: 'Ben', type: 'customer'},
                    {name: 'Raj', type: 'both'}
                ],
                nextPondId: 4
            };
            
            await userRef.set(defaultData);
            console.log('User data initialized');
        }

        async function loadUserData() {
            if (!currentUser) return;
            
            console.log('Loading user data from Firebase...');
            try {
                const userRef = getUserDataRef();
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();
                
                if (userData) {
                    appData = userData;
                    console.log('User data loaded successfully');
                } else {
                    console.log('No user data found, initializing...');
                    await initializeUserData();
                }
                
                updateAllDisplays();
            } catch (error) {
                console.error('Error loading user data:', error);
                showError('Failed to load data. Please refresh the page.');
            }
        }

        async function saveData() {
            if (!isAuthenticated || !currentUser) {
                console.log('User not authenticated');
                return false;
            }

            try {
                console.log('Saving data to Firebase...');
                const userRef = getUserDataRef();
                await userRef.set(appData);
                console.log('Data saved successfully');
                return true;
            } catch (error) {
                console.error('Error saving data:', error);
                showError('Failed to save data: ' + error.message);
                return false;
            }
        }

        // UI Update Functions
        function updateAllDisplays() {
            updateDashboard();
            updateFishTypeDropdowns();
            updatePondDropdowns();
            updatePersonDropdowns();
            updateExpenseCategoryDropdown();
            updatePondGrid();
            updateReports();
            updateSettingsLists();
        }

        function getDateRange(period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let startDate, endDate;
            
            switch(period) {
                case 'today':
                    startDate = today;
                    endDate = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                    break;
                case 'week':
                    const dayOfWeek = today.getDay();
                    startDate = new Date(today.getTime() - dayOfWeek * 24 * 60 * 60 * 1000);
                    endDate = new Date(startDate.getTime() + 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    endDate = new Date(now.getFullYear(), quarter * 3 + 3, 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear() + 1, 0, 1);
                    break;
            }
            
            return { startDate, endDate };
        }

        function updateDashboard() {
            const { startDate, endDate } = getDateRange(appData.currentDashboardPeriod);
            
            let income = 0;
            let expense = 0;
            
            appData.transactions.forEach(t => {
                const tDate = new Date(t.date);
                if (tDate >= startDate && tDate < endDate) {
                    if (t.type === 'sale') {
                        income += t.totalAmount;
                    } else if (t.type === 'purchase') {
                        expense += t.totalAmount;
                    } else if (t.type === 'trading') {
                        income += t.totalAmount;
                        expense += t.totalCost || 0;
                    }
                }
            });
            
            appData.expenses.forEach(e => {
                const eDate = new Date(e.date);
                if (eDate >= startDate && eDate < endDate) {
                    expense += e.amount;
                }
            });
            
            const profit = income - expense;
            
            const periodText = appData.currentDashboardPeriod === 'today' ? "Today's" : 
                              appData.currentDashboardPeriod === 'week' ? "This Week's" : 
                              appData.currentDashboardPeriod === 'month' ? "This Month's" : 
                              "This Year's";
            
            document.getElementById('periodLabel').textContent = periodText;
            document.getElementById('periodLabelExpense').textContent = periodText;
            document.getElementById('periodLabelProfit').textContent = periodText;
            
            document.getElementById('periodIncome').textContent = formatMoney(income);
            document.getElementById('periodExpense').textContent = formatMoney(expense);
            document.getElementById('periodProfit').textContent = formatMoney(profit);
            document.getElementById('activePonds').textContent = appData.ponds.length;
            
            updateRecentTransactions();
        }

        function updateRecentTransactions() {
            const container = document.getElementById('recentTransactions');
            const allItems = [
                ...appData.transactions.map(t => ({...t, category: 'transaction'})),
                ...appData.expenses.map(e => ({...e, category: 'expense'}))
            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            
            if (allItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📋</div>
                        <h3>No transactions yet</h3>
                        <p>Start by adding a new transaction!</p>
                    </div>
                `;
            } else {
                container.innerHTML = allItems.map(item => {
                    if (item.category === 'transaction') {
                        let profitText = '';
                        if (item.type === 'trading' && item.totalCost) {
                            const profit = item.totalAmount - item.totalCost;
                            profitText = `<br><small style="color: ${profit >= 0 ? 'green' : 'red'}">Profit: ${formatMoney(profit)}</small>`;
                        }
                        return `
                            <div class="transaction-item">
                                <div>
                                    <strong>${item.personName || 'Unknown'}</strong><br>
                                    <small>${new Date(item.date).toLocaleDateString('en-IN')}</small>
                                    ${profitText}
                                </div>
                                <div style="text-align: right;">
                                    <span class="transaction-type type-${item.type}">${item.type}</span><br>
                                    <strong>${formatMoney(item.totalAmount)}</strong>
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="transaction-item">
                                <div>
                                    <strong>${item.description || item.employeeName || ''}</strong><br>
                                    <small>${new Date(item.date).toLocaleDateString('en-IN')}</small>
                                </div>
                                <div style="text-align: right;">
                                    <span class="transaction-type type-expense">expense</span><br>
                                    <strong>${formatMoney(item.amount)}</strong>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
            }
        }

        // Transaction Functions
        function calculateTotals() {
            let total = 0;
            let totalCost = 0;
            const transactionType = document.getElementById('transactionType').value;
            
            document.querySelectorAll('.fish-entry').forEach(entry => {
                const quantity = parseFloat(entry.querySelector('.fish-quantity').value) || 0;
                const rate = parseFloat(entry.querySelector('.fish-rate').value) || 0;
                const buyRate = parseFloat(entry.querySelector('.fish-buy-rate')?.value) || 0;
                
                const amount = quantity * rate;
                total += amount;
                
                if (transactionType === 'trading' && buyRate > 0) {
                    totalCost += quantity * buyRate;
                }
            });
            
            document.getElementById('totalAmount').textContent = total.toLocaleString('en-IN');
            
            if (transactionType === 'trading' && totalCost > 0) {
                const profit = total - totalCost;
                document.getElementById('totalAmount').textContent = 
                    `${total.toLocaleString('en-IN')} (Profit: ${formatMoney(profit)})`;
            }
        }

        function addPondDistribution(entryNum) {
            const container = document.getElementById(`pondDist${entryNum}`);
            const newDist = document.createElement('div');
            newDist.className = 'pond-distribution-item';
            newDist.innerHTML = `
                <select class="pond-select">
                    <option value="">Select Pond</option>
                    ${appData.ponds.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                </select>
                <input type="number" class="pond-quantity" placeholder="Quantity">
                <button type="button" class="remove-btn" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(newDist);
        }

        function addFishEntry() {
            fishEntryCount++;
            const container = document.getElementById('fishEntries');
            const transactionType = document.getElementById('transactionType').value;
            
            const newEntry = document.createElement('div');
            newEntry.className = 'fish-entry';
            newEntry.innerHTML = `
                <h4>
                    <span><span class="fish-icon">🐟</span> Fish Details #${fishEntryCount}</span>
                    <button class="remove-btn" onclick="removeFishEntry(this)">Remove</button>
                </h4>
                <div class="row">
                    <div class="form-group">
                        <label>Fish Type</label>
                        <select class="fish-type" required onchange="calculateTotals()">
                            <option value="">Select Fish</option>
                            ${appData.fishTypes.map(f => `<option value="${f}">${f}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" class="fish-quantity" placeholder="e.g., 1000" required onchange="calculateTotals()">
                    </div>
                    <div class="form-group">
                        <label class="rate-label">${transactionType === 'trading' ? 'Sell Rate (₹)' : 'Rate per Fish (₹)'}</label>
                        <input type="number" step="0.01" class="fish-rate" placeholder="e.g., 1.5" required onchange="calculateTotals()">
                    </div>
                    ${transactionType === 'trading' ? `
                    <div class="form-group trading-field">
                        <label>Buy Rate (₹)</label>
                        <input type="number" step="0.01" class="fish-buy-rate" placeholder="e.g., 1.2" onchange="calculateTotals()">
                    </div>` : ''}
                </div>
                ${transactionType !== 'trading' ? `
                <div class="pond-section">
                    <label class="pond-label">${transactionType === 'sale' ? 'Sold from Pond' : 'Assign to Pond'}</label>
                    <div class="pond-distribution" id="pondDist${fishEntryCount}">
                        <div class="pond-distribution-item">
                            <select class="pond-select">
                                <option value="">Select Pond</option>
                                ${appData.ponds.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                            <input type="number" class="pond-quantity" placeholder="Quantity">
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm" onclick="addPondDistribution(${fishEntryCount})" style="padding: 5px 10px; font-size: 12px;">+ Add Another Pond</button>
                </div>` : ''}
            `;
            container.appendChild(newEntry);
        }

        function removeFishEntry(button) {
            button.closest('.fish-entry').remove();
            fishEntryCount--;
            calculateTotals();
        }

        function calculatePondStock(pondId, fishType) {
            let stock = 0;
            
            appData.transactions.forEach(t => {
                if (t.fishDetails) {
                    t.fishDetails.forEach(f => {
                        if (f.pondId == pondId && f.type === fishType) {
                            if (t.type === 'purchase') {
                                stock += f.quantity;
                            } else if (t.type === 'sale') {
                                stock -= f.quantity;
                            }
                        }
                    });
                }
            });
            
            (appData.stockAdjustments || []).forEach(a => {
                if (a.pondId == pondId && a.fishType === fishType) {
                    stock += a.quantity;
                }
            });
            
            return stock;
        }

        function updateTransactionForm() {
            const type = document.getElementById('transactionType').value;
            const personLabel = document.getElementById('personLabel');
            
            if (type === 'purchase') {
                personLabel.textContent = 'Vendor Name';
            } else if (type === 'sale') {
                personLabel.textContent = 'Customer Name';
            } else if (type === 'trading') {
                personLabel.textContent = 'Customer Name';
            }
            
            document.querySelectorAll('.fish-entry').forEach((entry, index) => {
                const rateLabel = entry.querySelector('.rate-label');
                const pondSection = entry.querySelector('.pond-section');
                const pondLabel = entry.querySelector('.pond-label');
                let tradingField = entry.querySelector('.trading-field');
                
                if (type === 'trading') {
                    if (rateLabel) rateLabel.textContent = 'Sell Rate (₹)';
                    if (pondSection) pondSection.style.display = 'none';
                    
                    if (!tradingField) {
                        const buyRateDiv = document.createElement('div');
                        buyRateDiv.className = 'form-group trading-field';
                        buyRateDiv.innerHTML = `
                            <label>Buy Rate (₹)</label>
                            <input type="number" step="0.01" class="fish-buy-rate" placeholder="e.g., 1.2" onchange="calculateTotals()">
                        `;
                        entry.querySelector('.row').appendChild(buyRateDiv);
                    } else {
                        tradingField.style.display = 'block';
                    }
                } else {
                    if (rateLabel) rateLabel.textContent = 'Rate per Fish (₹)';
                    if (pondSection) pondSection.style.display = 'block';
                    if (pondLabel) {
                        pondLabel.textContent = type === 'sale' ? 'Sold from Pond' : 'Assign to Pond';
                    }
                    if (tradingField) tradingField.style.display = 'none';
                }
            });
            
            calculateTotals();
        }

        function updateExpenseForm() {
            const type = document.getElementById('expenseType').value;
            document.getElementById('pondSelectDiv').style.display = type === 'pond' ? 'block' : 'none';
            document.getElementById('employeeDiv').style.display = type === 'salary' ? 'block' : 'none';
        }

        function updateExpenseCategoryDropdown() {
            const select = document.getElementById('expenseCategory');
            if (select) {
                select.innerHTML = `
                    <option value="">Select Category</option>
                    ${appData.expenseCategories.map(c => `<option value="${c}">${c}</option>`).join('')}
                    <option value="__new__">Add New Category</option>
                `;
                
                select.onchange = function() {
                    document.getElementById('newCategoryDiv').style.display = 
                        this.value === '__new__' ? 'flex' : 'none';
                };
            }
        }

        function addNewCategory() {
            const input = document.getElementById('newCategoryInput');
            const category = input.value.trim();
            
            if (category && !appData.expenseCategories.includes(category)) {
                appData.expenseCategories.push(category);
                saveData();
                input.value = '';
                document.getElementById('newCategoryDiv').style.display = 'none';
                updateExpenseCategoryDropdown();
                document.getElementById('expenseCategory').value = category;
            }
        }

        // Dropdown Updates
        function updateFishTypeDropdowns() {
            document.querySelectorAll('.fish-type').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = `
                    <option value="">Select Fish</option>
                    ${appData.fishTypes.map(f => `<option value="${f}">${f}</option>`).join('')}
                `;
                select.value = currentValue;
            });
            
            const pondFishSelect = document.getElementById('pondFishType');
            if (pondFishSelect) {
                pondFishSelect.innerHTML = `
                    <option value="">Select Fish Type</option>
                    ${appData.fishTypes.map(f => `<option value="${f}">${f}</option>`).join('')}
                `;
            }

            const adjustFishSelect = document.getElementById('adjustFishType');
            if (adjustFishSelect) {
                adjustFishSelect.innerHTML = `
                    <option value="">Select Fish</option>
                    ${appData.fishTypes.map(f => `<option value="${f}">${f}</option>`).join('')}
                `;
            }
        }

        function updatePondDropdowns() {
            const pondSelects = [
                ...document.querySelectorAll('.pond-select'),
                document.getElementById('expensePond'),
                document.getElementById('adjustPond')
            ];
            
            pondSelects.forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = `
                        <option value="">Select Pond</option>
                        ${appData.ponds.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                    `;
                    select.value = currentValue;
                }
            });
        }

        function updatePersonDropdowns() {
            const select = document.getElementById('personName');
            if (select) {
                select.innerHTML = `
                    <option value="">Select or Add New</option>
                    ${appData.people.map(p => `<option value="${p.name}">${p.name} (${p.type})</option>`).join('')}
                `;
            }
        }

        function updatePondGrid() {
            const grid = document.getElementById('pondGrid');
            if (!grid) return;
            
            if (appData.ponds.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="icon">🏊</div>
                        <h3>No ponds added yet</h3>
                        <p>Click "Add New Pond" to get started!</p>
                    </div>
                `;
            } else {
                grid.innerHTML = appData.ponds.map(pond => {
                    const stockByFish = {};
                    let investment = 0;
                    let revenue = 0;
                    let expenses = 0;
                    
                    appData.transactions.forEach(t => {
                        if (t.fishDetails) {
                            t.fishDetails.forEach(f => {
                                if (f.pondId == pond.id) {
                                    if (!stockByFish[f.type]) stockByFish[f.type] = 0;
                                    
                                    if (t.type === 'purchase') {
                                        stockByFish[f.type] += f.quantity;
                                        investment += f.amount;
                                    } else if (t.type === 'sale') {
                                        stockByFish[f.type] -= f.quantity;
                                        revenue += f.amount;
                                    }
                                }
                            });
                        }
                    });
                    
                    (appData.stockAdjustments || []).forEach(a => {
                        if (a.pondId == pond.id) {
                            if (!stockByFish[a.fishType]) stockByFish[a.fishType] = 0;
                            stockByFish[a.fishType] += a.quantity;
                        }
                    });
                    
                    appData.expenses.forEach(e => {
                        if (e.pondId == pond.id) {
                            expenses += e.amount;
                        }
                    });
                    
                    const totalFish = Object.values(stockByFish).reduce((sum, count) => sum + Math.max(0, count), 0);
                    const fishTypes = Object.keys(stockByFish).filter(f => stockByFish[f] > 0);
                    const profit = revenue - investment - expenses;
                    
                    return `
                        <div class="pond-card">
                            <button class="edit-pond-btn" onclick="showAdjustStockModal()">✏️</button>
                            <h3>${pond.name}</h3>
                            <div class="count">${totalFish.toLocaleString('en-IN')}</div>
                            <small>Fish Count</small>
                            ${fishTypes.length > 0 ? `
                                <div class="fish-types">
                                    ${fishTypes.slice(0, 3).join(', ')}
                                    ${fishTypes.length > 3 ? ` +${fishTypes.length - 3} more` : ''}
                                </div>
                            ` : '<div class="fish-types">No fish</div>'}
                            <div style="margin-top: 10px; font-size: 12px;">
                                Capacity: ${pond.capacity.toLocaleString('en-IN')}<br>
                                Investment: ${formatMoney(investment)}<br>
                                Profit: <span style="color: ${profit >= 0 ? '#38ef7d' : '#f5576c'}">${formatMoney(profit)}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function updateReports() {
            const { startDate, endDate } = getDateRange(appData.currentReportPeriod);
            
            let income = 0;
            let expense = 0;
            
            appData.transactions.forEach(t => {
                const tDate = new Date(t.date);
                if (tDate >= startDate && tDate < endDate) {
                    if (t.type === 'sale') {
                        income += t.totalAmount;
                    } else if (t.type === 'purchase') {
                        expense += t.totalAmount;
                    } else if (t.type === 'trading') {
                        income += t.totalAmount;
                        expense += t.totalCost || 0;
                    }
                }
            });
            
            appData.expenses.forEach(e => {
                const eDate = new Date(e.date);
                if (eDate >= startDate && eDate < endDate) {
                    expense += e.amount;
                }
            });
            
            const profit = income - expense;
            
            const periodText = appData.currentReportPeriod === 'month' ? 'This Month' :
                              appData.currentReportPeriod === 'quarter' ? 'This Quarter' :
                              'This Year';
            
            document.getElementById('reportPeriodLabel').textContent = periodText;
            document.getElementById('reportPeriodLabelExpense').textContent = periodText;
            document.getElementById('reportPeriodLabelProfit').textContent = periodText;
            
            document.getElementById('reportIncome').textContent = formatMoney(income);
            document.getElementById('reportExpense').textContent = formatMoney(expense);
            document.getElementById('reportProfit').textContent = formatMoney(profit);
            
            const pondProfitReport = document.getElementById('pondProfitReport');
            if (pondProfitReport) {
                const pondProfits = appData.ponds.map(pond => {
                    let income = 0;
                    let expense = 0;
                    
                    appData.transactions.forEach(t => {
                        const tDate = new Date(t.date);
                        if (tDate >= startDate && tDate < endDate && t.fishDetails) {
                            t.fishDetails.forEach(f => {
                                if (f.pondId == pond.id) {
                                    if (t.type === 'sale') {
                                        income += f.amount;
                                    } else if (t.type === 'purchase') {
                                        expense += f.amount;
                                    }
                                }
                            });
                        }
                    });
                    
                    appData.expenses.forEach(e => {
                        const eDate = new Date(e.date);
                        if (eDate >= startDate && eDate < endDate && e.pondId == pond.id) {
                            expense += e.amount;
                        }
                    });
                    
                    return {
                        name: pond.name,
                        income: income,
                        expense: expense,
                        profit: income - expense
                    };
                });
                
                pondProfitReport.innerHTML = `
                    <div class="transaction-list">
                        ${pondProfits.map(p => `
                            <div class="transaction-item">
                                <div>
                                    <strong>${p.name}</strong><br>
                                    <small>Income: ${formatMoney(p.income)} | Expense: ${formatMoney(p.expense)}</small>
                                </div>
                                <div>
                                    <strong style="color: ${p.profit >= 0 ? '#28a745' : '#dc3545'}">
                                        ${formatMoney(p.profit)}
                                    </strong>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function updateSettingsLists() {
            const fishTypesList = document.getElementById('fishTypesList');
            if (fishTypesList) {
                if (appData.fishTypes.length === 0) {
                    fishTypesList.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">🐟</div>
                            <h3>No fish types added</h3>
                            <p>Add fish types to organize your inventory.</p>
                        </div>`;
                } else {
                    fishTypesList.innerHTML = appData.fishTypes.map(f => `
                        <div class="list-item">
                            <span>🐟 ${f}</span>
                            <button class="btn btn-danger" onclick="removeFishType('${f}')">Remove</button>
                        </div>
                    `).join('');
                }
            }
            
            const peopleList = document.getElementById('peopleList');
            if (peopleList) {
                if (appData.people.length === 0) {
                    peopleList.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">👥</div>
                            <h3>No people added</h3>
                            <p>Add customers and suppliers for transaction tracking.</p>
                        </div>`;
                } else {
                    peopleList.innerHTML = appData.people.map(p => `
                        <div class="list-item">
                            <div>
                                <div style="font-weight: 600;">${p.name}</div>
                                <div style="font-size: 12px; text-transform: capitalize; color: #6c757d;">${p.type}</div>
                            </div>
                            <button class="btn btn-danger" onclick="removePerson('${p.name}')">Remove</button>
                        </div>
                    `).join('');
                }
            }
        }

        // Tab Management
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
                
                const tabButton = document.querySelector(`.tab[data-tab="${tabName}"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
                
                updateAllDisplays();
            }
        }

        function changeDashboardPeriod(period, btn) {
            appData.currentDashboardPeriod = period;
            document.querySelectorAll('#dashboard .period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (btn) btn.classList.add('active');
            updateDashboard();
            saveData();
        }

        function changeReportPeriod(period, btn) {
            appData.currentReportPeriod = period;
            document.querySelectorAll('#reports .period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (btn) btn.classList.add('active');
            updateReports();
            saveData();
        }

        // Settings Functions
        function addFishType() {
            const input = document.getElementById('newFishType');
            const fishType = input.value.trim();
            
            if (fishType && !appData.fishTypes.includes(fishType)) {
                appData.fishTypes.push(fishType);
                saveData();
                input.value = '';
                updateAllDisplays();
                showTransactionSuccess('Fish type added successfully!');
            }
        }

        function removeFishType(fishType) {
            if (confirm(`Are you sure you want to remove "${fishType}"?`)) {
                appData.fishTypes = appData.fishTypes.filter(f => f !== fishType);
                saveData();
                updateAllDisplays();
                showTransactionSuccess('Fish type removed successfully!');
            }
        }

        function addPerson() {
            const nameInput = document.getElementById('newPersonInput');
            const typeSelect = document.getElementById('personType');
            const name = nameInput.value.trim();
            
            if (name && !appData.people.find(p => p.name === name)) {
                appData.people.push({
                    name: name,
                    type: typeSelect.value
                });
                saveData();
                nameInput.value = '';
                updateAllDisplays();
                showTransactionSuccess('Person added successfully!');
            }
        }

        function removePerson(name) {
            if (confirm(`Are you sure you want to remove "${name}"?`)) {
                appData.people = appData.people.filter(p => p.name !== name);
                saveData();
                updateAllDisplays();
                showTransactionSuccess('Person removed successfully!');
            }
        }

        // Modal Functions
        function showAddPondModal() {
            document.getElementById('addPondModal').classList.add('active');
            updateFishTypeDropdowns();
        }

        function showAdjustStockModal() {
            document.getElementById('adjustStockModal').classList.add('active');
            updatePondDropdowns();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function loadPondStock() {
            const pondId = document.getElementById('adjustPond').value;
            if (!pondId) {
                document.getElementById('currentStockInfo').style.display = 'none';
                return;
            }
            
            const pond = appData.ponds.find(p => p.id == pondId);
            const stockByFish = {};
            
            appData.transactions.forEach(t => {
                if (t.fishDetails) {
                    t.fishDetails.forEach(f => {
                        if (f.pondId == pondId) {
                            if (!stockByFish[f.type]) stockByFish[f.type] = 0;
                            
                            if (t.type === 'purchase') {
                                stockByFish[f.type] += f.quantity;
                            } else if (t.type === 'sale') {
                                stockByFish[f.type] -= f.quantity;
                            }
                        }
                    });
                }
            });
            
            (appData.stockAdjustments || []).forEach(a => {
                if (a.pondId == pondId) {
                    if (!stockByFish[a.fishType]) stockByFish[a.fishType] = 0;
                    stockByFish[a.fishType] += a.quantity;
                }
            });
            
            const stockDetails = document.getElementById('stockDetails');
            stockDetails.innerHTML = Object.entries(stockByFish)
                .filter(([fish, count]) => count > 0)
                .map(([fish, count]) => `<div>🐟 ${fish}: ${count.toLocaleString('en-IN')} fish</div>`)
                .join('') || '<div>No fish in this pond</div>';
            
            document.getElementById('currentStockInfo').style.display = 'block';
            
            const fishSelect = document.getElementById('adjustFishType');
            fishSelect.innerHTML = `
                <option value="">Select Fish</option>
                ${Object.keys(stockByFish).map(f => `<option value="${f}">${f}</option>`).join('')}
                ${appData.fishTypes.filter(f => !stockByFish[f]).map(f => `<option value="${f}">${f}</option>`).join('')}
            `;
        }

        // Data Management Functions
        function exportData() {
            const exportData = {
                ...appData,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `cochin_aquatics_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showTransactionSuccess('Data exported successfully!');
        }

        function backupData() {
            exportData();
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const imported = JSON.parse(event.target.result);
                        appData = imported;
                        saveData();
                        updateAllDisplays();
                        showTransactionSuccess('Data restored successfully!');
                    } catch (error) {
                        showError('Error restoring data. Please check the file.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone!')) {
                if (confirm('This will delete everything! Are you really sure?')) {
                    appData = {
                        transactions: [],
                        expenses: [],
                        ponds: [],
                        stockAdjustments: [],
                        fishTypes: ['Gold Fish', 'Angel Fish', 'Black Moors', 'Carp', 'Tetra', 'Guppy', 'Koi', 'Molly', 'Platy', 'Swordtail'],
                        expenseCategories: ['Cleaning', 'Feed', 'Medicine', 'Electricity', 'Maintenance', 'Transport', 'Salary', 'Water Treatment', 'Equipment', 'Other'],
                        people: [],
                        nextTransactionId: 1,
                        nextExpenseId: 1,
                        nextPondId: 1,
                        nextAdjustmentId: 1,
                        currentDashboardPeriod: 'today',
                        currentReportPeriod: 'month'
                    };
                    saveData();
                    updateAllDisplays();
                    showTransactionSuccess('All data cleared successfully!');
                }
            }
        }

        function showTransactionSuccess(message) {
            const successElements = [
                document.getElementById('transactionSuccess'),
                document.getElementById('expenseSuccess')
            ];
            
            successElements.forEach(el => {
                if (el) {
                    el.textContent = message;
                    el.classList.add('show');
                    setTimeout(() => el.classList.remove('show'), 3000);
                }
            });
        }

        // Form Event Handlers
        let isSubmitting = false;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Starting Cochin Aquatics System v2.0...');
            
            try {
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                setTimeout(() => {
                    const transactionDateField = document.getElementById('transactionDate');
                    const expenseDateField = document.getElementById('expenseDate');
                    
                    if (transactionDateField) transactionDateField.value = today;
                    if (expenseDateField) expenseDateField.value = today;
                }, 100);

                // Setup tab switching
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        const targetTab = this.dataset.tab;
                        switchTab(targetTab);
                    });
                });

                // Setup period switching for dashboard
                document.querySelectorAll('#dashboard .period-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        changeDashboardPeriod(this.dataset.period, this);
                    });
                });

                // Setup period switching for reports
                document.querySelectorAll('#reports .period-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        changeReportPeriod(this.dataset.period, this);
                    });
                });

                // Transaction form handlers
                document.getElementById('transactionType').addEventListener('change', updateTransactionForm);
                document.getElementById('expenseType').addEventListener('change', updateExpenseForm);
                document.getElementById('adjustPond').addEventListener('change', loadPondStock);

                // Form submissions
                document.getElementById('transactionForm').addEventListener('submit', handleTransactionSubmit);
                document.getElementById('expenseForm').addEventListener('submit', handleExpenseSubmit);
                document.getElementById('addPondForm').addEventListener('submit', handleAddPondSubmit);
                document.getElementById('adjustStockForm').addEventListener('submit', handleAdjustStockSubmit);

                // Initialize Firebase auth
                initializeAuth();

                console.log('System initialized successfully!');
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('System initialization failed. Please refresh the page.');
            }
        });

        async function handleTransactionSubmit(e) {
            e.preventDefault();
            
            if (isSubmitting) return;
            isSubmitting = true;
            
            try {
                const transaction = {
                    id: appData.nextTransactionId++,
                    date: document.getElementById('transactionDate').value,
                    type: document.getElementById('transactionType').value,
                    personName: document.getElementById('personName').value || document.getElementById('newPersonName').value,
                    fishDetails: [],
                    totalAmount: 0,
                    totalCost: 0,
                    notes: document.getElementById('transactionNotes').value
                };
                
                if (!transaction.type || !transaction.personName) {
                    showError('Please fill in all required fields');
                    return;
                }
                
                // Collect fish details
                const fishEntries = document.querySelectorAll('.fish-entry');
                let hasError = false;
                
                for (let i = 0; i < fishEntries.length; i++) {
                    const entry = fishEntries[i];
                    const fishType = entry.querySelector('.fish-type').value;
                    const totalQuantity = parseFloat(entry.querySelector('.fish-quantity').value) || 0;
                    const rate = parseFloat(entry.querySelector('.fish-rate').value) || 0;
                    const buyRate = parseFloat(entry.querySelector('.fish-buy-rate')?.value) || 0;
                    
                    if (fishType && totalQuantity && rate) {
                        if (transaction.type === 'trading') {
                            const fishDetail = {
                                type: fishType,
                                quantity: totalQuantity,
                                rate: rate,
                                buyRate: buyRate,
                                amount: totalQuantity * rate,
                                cost: totalQuantity * buyRate,
                                profit: (totalQuantity * rate) - (totalQuantity * buyRate)
                            };
                            transaction.fishDetails.push(fishDetail);
                            transaction.totalAmount += fishDetail.amount;
                            transaction.totalCost += fishDetail.cost;
                        } else {
                            // Handle pond distribution
                            const pondDistributions = [];
                            let distributedQuantity = 0;
                            
                            entry.querySelectorAll('.pond-distribution-item').forEach(dist => {
                                const pondId = dist.querySelector('.pond-select').value;
                                const quantity = parseFloat(dist.querySelector('.pond-quantity').value) || 0;
                                
                                if (pondId && quantity > 0) {
                                    pondDistributions.push({ pondId, quantity });
                                    distributedQuantity += quantity;
                                }
                            });
                            
                            // Default to first pond if no distribution
                            if (pondDistributions.length === 0 && appData.ponds.length > 0) {
                                pondDistributions.push({ 
                                    pondId: appData.ponds[0].id, 
                                    quantity: totalQuantity 
                                });
                                distributedQuantity = totalQuantity;
                            }
                            
                            // Validate stock for sales
                            if (transaction.type === 'sale') {
                                for (const dist of pondDistributions) {
                                    const availableStock = calculatePondStock(dist.pondId, fishType);
                                    if (dist.quantity > availableStock) {
                                        const pond = appData.ponds.find(p => p.id == dist.pondId);
                                        showError(`Insufficient stock in ${pond.name}! ${fishType}: ${dist.quantity} requested, ${availableStock} available`);
                                        hasError = true;
                                        break;
                                    }
                                }
                            }
                            
                            if (!hasError) {
                                pondDistributions.forEach(dist => {
                                    const fishDetail = {
                                        type: fishType,
                                        quantity: dist.quantity,
                                        rate: rate,
                                        pondId: dist.pondId,
                                        amount: dist.quantity * rate
                                    };
                                    transaction.fishDetails.push(fishDetail);
                                    transaction.totalAmount += fishDetail.amount;
                                });
                            }
                        }
                    }
                }
                
                if (hasError) return;
                
                if (transaction.fishDetails.length === 0) {
                    showError('Please add at least one fish entry!');
                    return;
                }
                
                // Add new person if entered
                const newPersonName = document.getElementById('newPersonName').value;
                if (newPersonName && !appData.people.find(p => p.name === newPersonName)) {
                    appData.people.push({
                        name: newPersonName,
                        type: transaction.type === 'purchase' ? 'vendor' : 'customer'
                    });
                }
                
                appData.transactions.push(transaction);
                await saveData();
                
                showTransactionSuccess(`${transaction.type} of ${formatMoney(transaction.totalAmount)} added successfully!`);
                
                // Reset form
                this.reset();
                document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
                
                // Reset fish entries
                document.getElementById('fishEntries').innerHTML = `
                    <div class="fish-entry">
                        <h4>
                            <span><span class="fish-icon">🐟</span> Fish Details #1</span>
                        </h4>
                        <div class="row">
                            <div class="form-group">
                                <label>Fish Type</label>
                                <select class="fish-type" required onchange="calculateTotals()">
                                    <option value="">Select Fish</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Quantity</label>
                                <input type="number" class="fish-quantity" placeholder="e.g., 1000" required onchange="calculateTotals()">
                            </div>
                            <div class="form-group">
                                <label class="rate-label">Rate per Fish (₹)</label>
                                <input type="number" step="0.01" class="fish-rate" placeholder="e.g., 1.5" required onchange="calculateTotals()">
                            </div>
                        </div>
                        <div class="pond-section">
                            <label class="pond-label">Assign to Pond</label>
                            <div class="pond-distribution" id="pondDist1">
                                <div class="pond-distribution-item">
                                    <select class="pond-select">
                                        <option value="">Select Pond</option>
                                    </select>
                                    <input type="number" class="pond-quantity" placeholder="Quantity">
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm" onclick="addPondDistribution(1)" style="padding: 5px 10px; font-size: 12px;">+ Add Another Pond</button>
                        </div>
                    </div>
                `;
                fishEntryCount = 1;
                document.getElementById('totalAmount').textContent = '0';
                
                updateAllDisplays();
                
            } catch (error) {
                console.error('Transaction error:', error);
                showError('Failed to save transaction. Please try again.');
            } finally {
                isSubmitting = false;
            }
        }

        async function handleExpenseSubmit(e) {
            e.preventDefault();
            
            try {
                const expenseType = document.getElementById('expenseType').value;
                const expenseCategory = document.getElementById('expenseCategory').value;
                const expenseAmount = parseFloat(document.getElementById('expenseAmount').value);
                
                if (!expenseType || !expenseCategory || !expenseAmount || expenseAmount <= 0) {
                    showError('Please fill in all required fields with valid values');
                    return;
                }
                
                const expense = {
                    id: appData.nextExpenseId++,
                    date: document.getElementById('expenseDate').value || new Date().toISOString().split('T')[0],
                    type: expenseType,
                    category: expenseCategory,
                    amount: expenseAmount,
                    description: document.getElementById('expenseDescription').value,
                    pondId: document.getElementById('expensePond').value,
                    employeeName: document.getElementById('employeeName').value
                };
                
                appData.expenses.push(expense);
                await saveData();
                
                showTransactionSuccess(`Expense of ${formatMoney(expenseAmount)} added successfully!`);
                
                this.reset();
                document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
                
                updateAllDisplays();
                
            } catch (error) {
                console.error('Expense error:', error);
                showError('Failed to save expense. Please try again.');
            }
        }

        async function handleAddPondSubmit(e) {
            e.preventDefault();
            
            try {
                const pondName = document.getElementById('pondName').value.trim();
                const pondCapacity = parseFloat(document.getElementById('pondCapacity').value) || 0;
                const pondFishType = document.getElementById('pondFishType').value;
                
                if (!pondName || pondCapacity <= 0) {
                    showError('Please enter valid pond name and capacity');
                    return;
                }
                
                if (appData.ponds.find(p => p.name.toLowerCase() === pondName.toLowerCase())) {
                    showError('A pond with this name already exists');
                    return;
                }
                
                const pond = {
                    id: appData.nextPondId++,
                    name: pondName,
                    capacity: pondCapacity,
                    primaryFishType: pondFishType
                };
                
                appData.ponds.push(pond);
                await saveData();
                
                closeModal('addPondModal');
                this.reset();
                updateAllDisplays();
                showTransactionSuccess(`Pond "${pondName}" added successfully!`);
                
            } catch (error) {
                console.error('Add pond error:', error);
                showError('Failed to add pond. Please try again.');
            }
        }

        async function handleAdjustStockSubmit(e) {
            e.preventDefault();
            
            try {
                const pondId = document.getElementById('adjustPond').value;
                const adjustmentType = document.getElementById('adjustmentType').value;
                const fishType = document.getElementById('adjustFishType').value;
                const quantity = parseFloat(document.getElementById('adjustQuantity').value);
                const notes = document.getElementById('adjustNotes').value;
                
                if (!pondId || !adjustmentType || !fishType || !quantity) {
                    showError('Please fill in all required fields');
                    return;
                }
                
                const adjustment = {
                    id: appData.nextAdjustmentId++,
                    date: new Date().toISOString(),
                    pondId: pondId,
                    type: adjustmentType,
                    fishType: fishType,
                    quantity: quantity,
                    notes: notes
                };
                
                if (!appData.stockAdjustments) {
                    appData.stockAdjustments = [];
                }
                appData.stockAdjustments.push(adjustment);
                
                await saveData();
                
                closeModal('adjustStockModal');
                this.reset();
                updateAllDisplays();
                showTransactionSuccess('Stock adjustment saved successfully!');
                
            } catch (error) {
                console.error('Stock adjustment error:', error);
                showError('Failed to save stock adjustment. Please try again.');
            }
        }

        // Initialize the application
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Cochin Aquatics System v2.0 - Starting...');
            
            try {
                // Wait for Firebase to be fully loaded
                if (typeof firebase !== 'undefined') {
                    console.log('Firebase loaded, initializing authentication...');
                    initializeAuth();
                } else {
                    console.error('Firebase not loaded!');
                    showError('System initialization failed. Please refresh the page.');
                }
                
            } catch (error) {
                console.error('System initialization error:', error);
                showError('System initialization failed. Please refresh the page.');
            }
        });

        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.error);
            console.error('At:', e.filename, 'Line:', e.lineno);
        });

        // Expose some functions globally for onclick handlers
        window.addFishEntry = addFishEntry;
        window.removeFishEntry = removeFishEntry;
        window.addPondDistribution = addPondDistribution;
        window.calculateTotals = calculateTotals;
        window.updateTransactionForm = updateTransactionForm;
        window.updateExpenseForm = updateExpenseForm;
        window.loadPondStock = loadPondStock;
        window.showAddPondModal = showAddPondModal;
        window.showAdjustStockModal = showAdjustStockModal;
        window.closeModal = closeModal;
        window.addFishType = addFishType;
        window.removeFishType = removeFishType;
        window.addPerson = addPerson;
        window.removePerson = removePerson;
        window.addNewCategory = addNewCategory;
        window.exportData = exportData;
        window.backupData = backupData;
        window.restoreData = restoreData;
        window.clearAllData = clearAllData;
