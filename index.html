<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cochin Aquatics Management System v2.0 - Multi-User</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Authentication Styles */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            text-align: center;
        }

        .auth-title {
            color: #1e3c72;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .auth-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .auth-input {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .auth-input:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .auth-btn {
            padding: 15px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
        }

        .auth-toggle {
            margin-top: 20px;
            color: #666;
            cursor: pointer;
        }

        .auth-toggle span {
            color: #1e3c72;
            font-weight: 600;
        }

        .user-info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 14px;
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 15px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 80px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e3c72;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            font-weight: 600;
        }

        .online-indicator {
            background: #28a745 !important;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .version-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            color: #1e3c72;
            border-bottom: 3px solid #1e3c72;
            background: white;
        }

        .content {
            padding: 20px;
            min-height: 400px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-add {
            background: #17a2b8;
            color: white;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .row .form-group {
            flex: 1;
            min-width: 200px;
        }

        /* Dashboard styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #1e3c72;
        }

        .dashboard-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .dashboard-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #1e3c72;
        }

        .period-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .period-btn.active {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }

        .fish-entry {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #1e3c72;
        }

        .fish-entry h4 {
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .pond-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .pond-distribution {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .pond-distribution select,
        .pond-distribution input {
            flex: 1;
        }

        .total-display {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            color: #1e3c72;
            text-align: center;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 15px;
            }
            
            .auth-container {
                margin: 20px auto;
                padding: 30px;
            }
            
            .row {
                flex-direction: column;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }

            .user-info, .logout-btn {
                position: static;
                display: inline-block;
                margin: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="offline-indicator" style="display: none;">
        üî¥ Offline
    </div>

    <!-- Authentication Container -->
    <div id="authContainer" class="auth-container">
        <h2 class="auth-title">üêü Cochin Aquatics</h2>
        <p class="auth-subtitle">Sign in to access your business management system</p>
        <div id="authForm" class="auth-form">
            <input type="email" id="authEmail" class="auth-input" placeholder="Email Address" required>
            <input type="password" id="authPassword" class="auth-input" placeholder="Password" required>
            <button id="authSubmit" class="auth-btn">Sign In</button>
            <div class="auth-toggle" id="toggleAuth">
                Don't have an account? <span>Sign Up</span>
            </div>
        </div>
        <div id="authError" style="color: #dc3545; margin-top: 15px; display: none; padding: 10px; background: #f8d7da; border-radius: 5px;"></div>
        <div id="authLoading" style="display: none; margin-top: 15px; color: #1e3c72;">
            <div class="loading-spinner"></div> Please wait...
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="appContainer" class="container" style="display: none;">
        <div class="header">
            <div class="user-info" id="userInfo">
                üë§ <span id="userEmail"></span>
            </div>
            <button id="logoutBtn" class="logout-btn">üö™ Logout</button>
            <h1>üêü Cochin Aquatics Management System</h1>
            <div class="subtitle">Multi-User ‚Ä¢ Real-Time ‚Ä¢ Cloud-Powered</div>
            <div class="version-badge">v2.0</div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="dashboard">üìä Dashboard</button>
            <button class="tab" data-tab="transaction">üí∞ New Transaction</button>
            <button class="tab" data-tab="expense">üí∏ Add Expense</button>
            <button class="tab" data-tab="ponds">üèä Ponds</button>
            <button class="tab" data-tab="reports">üìà Reports</button>
            <button class="tab" data-tab="settings">‚öôÔ∏è Settings</button>
        </div>

        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="period-controls">
                    <button class="period-btn active" onclick="changeDashboardPeriod('today', this)">Today</button>
                    <button class="period-btn" onclick="changeDashboardPeriod('week', this)">This Week</button>
                    <button class="period-btn" onclick="changeDashboardPeriod('month', this)">This Month</button>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>üí∞ Total Income</h3>
                        <div class="value" id="totalIncome">‚Çπ0</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>üí∏ Total Expenses</h3>
                        <div class="value" id="totalExpenses">‚Çπ0</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>üìà Net Profit</h3>
                        <div class="value" id="netProfit">‚Çπ0</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>üêü Total Fish</h3>
                        <div class="value" id="totalFish">0</div>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üìä Recent Activity</h3>
                    <div id="recentActivity">
                        <p style="color: #666;">Your recent transactions and expenses will appear here...</p>
                    </div>
                </div>
            </div>

            <!-- Transaction Tab -->
            <div id="transaction" class="tab-content">
                <div class="success-message" id="transactionSuccess">
                    ‚úÖ Transaction saved successfully!
                </div>

                <form id="transactionForm">
                    <div class="row">
                        <div class="form-group">
                            <label>Transaction Date</label>
                            <input type="date" id="transactionDate" required>
                        </div>
                        <div class="form-group">
                            <label>Transaction Type</label>
                            <select id="transactionType" required onchange="updateTransactionForm()">
                                <option value="">Select Type</option>
                                <option value="purchase">üõí Purchase (Buying Fish)</option>
                                <option value="sale">üí∞ Sale (Selling Fish)</option>
                                <option value="trading">üîÑ Trading (Buy & Sell)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="personLabel">Vendor/Customer Name</label>
                        <input type="text" id="personName" placeholder="Enter name" required>
                    </div>

                    <div id="fishEntries">
                        <div class="fish-entry">
                            <h4>üêü Fish Details #1</h4>
                            <div class="row">
                                <div class="form-group">
                                    <label>Fish Type</label>
                                    <select class="fish-type" required onchange="calculateTotals()">
                                        <option value="">Select Fish</option>
                                        <option value="Gold Fish">Gold Fish</option>
                                        <option value="Angel Fish">Angel Fish</option>
                                        <option value="Black Moors">Black Moors</option>
                                        <option value="Carp">Carp</option>
                                        <option value="Tetra">Tetra</option>
                                        <option value="Guppy">Guppy</option>
                                        <option value="Koi">Koi</option>
                                        <option value="Molly">Molly</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Quantity</label>
                                    <input type="number" class="fish-quantity" placeholder="e.g., 1000" required onchange="calculateTotals()">
                                </div>
                                <div class="form-group">
                                    <label class="rate-label">Rate per Fish (‚Çπ)</label>
                                    <input type="number" step="0.01" class="fish-rate" placeholder="e.g., 1.5" required onchange="calculateTotals()">
                                </div>
                            </div>
                            <div class="pond-section">
                                <label>Assign to Pond</label>
                                <div class="pond-distribution">
                                    <select class="pond-select">
                                        <option value="">Select Pond</option>
                                        <option value="1">Pond 1</option>
                                        <option value="2">Pond 2</option>
                                        <option value="3">Pond 3</option>
                                    </select>
                                    <input type="number" class="pond-quantity" placeholder="Quantity">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-add" onclick="addFishEntry()">‚ûï Add More Fish</button>

                    <div class="form-group" style="margin-top: 20px;">
                        <div class="total-display">
                            Total Amount: ‚Çπ<span id="totalAmount">0</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="transactionNotes" rows="3" placeholder="Any additional details..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        üíæ Save Transaction
                    </button>
                </form>
            </div>

            <!-- Expense Tab -->
            <div id="expense" class="tab-content">
                <div class="success-message" id="expenseSuccess">
                    ‚úÖ Expense added successfully!
                </div>

                <form id="expenseForm">
                    <div class="row">
                        <div class="form-group">
                            <label>Expense Date</label>
                            <input type="date" id="expenseDate" required>
                        </div>
                        <div class="form-group">
                            <label>Expense Type</label>
                            <select id="expenseType" required onchange="updateExpenseForm()">
                                <option value="">Select Type</option>
                                <option value="pond">üèä Pond Specific Expense</option>
                                <option value="general">üè¢ General Farm Expense</option>
                                <option value="salary">üë∑ Employee Salary</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="pondSelectDiv" style="display: none;">
                        <label>Select Pond</label>
                        <select id="expensePond">
                            <option value="">Select Pond</option>
                            <option value="1">Pond 1</option>
                            <option value="2">Pond 2</option>
                            <option value="3">Pond 3</option>
                        </select>
                    </div>

                    <div class="form-group" id="employeeDiv" style="display: none;">
                        <label>Employee Name</label>
                        <input type="text" id="employeeName" placeholder="Enter employee name">
                    </div>

                    <div class="form-group">
                        <label>Expense Category</label>
                        <select id="expenseCategory" required>
                            <option value="">Select Category</option>
                            <option value="Cleaning">Cleaning</option>
                            <option value="Feed">Feed</option>
                            <option value="Medicine">Medicine</option>
                            <option value="Electricity">Electricity</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Transport">Transport</option>
                            <option value="Salary">Salary</option>
                            <option value="Water Treatment">Water Treatment</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Amount (‚Çπ)</label>
                        <input type="number" id="expenseAmount" placeholder="Enter amount" required>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="expenseDescription" rows="3" placeholder="Describe the expense..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        üíæ Save Expense
                    </button>
                </form>
            </div>

            <!-- Ponds Tab -->
            <div id="ponds" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">üèä Pond Management</h2>
                
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>üèä Pond 1</h3>
                        <div style="color: #666; margin: 10px 0;">Capacity: 10,000 fish</div>
                        <div style="color: #666;">Primary: Gold Fish</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>üèä Pond 2</h3>
                        <div style="color: #666; margin: 10px 0;">Capacity: 8,000 fish</div>
                        <div style="color: #666;">Primary: Angel Fish</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>üèä Pond 3</h3>
                        <div style="color: #666; margin: 10px 0;">Capacity: 12,000 fish</div>
                        <div style="color: #666;">Primary: Carp</div>
                    </div>
                </div>
                
                <div style="text-align: center; padding: 40px; color: #666;">
                    <p>Advanced pond management features will be available in the next update!</p>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">üìà Business Reports</h2>
                
                <div class="period-controls">
                    <button class="period-btn active" onclick="changeReportPeriod('month', this)">Monthly</button>
                    <button class="period-btn" onclick="changeReportPeriod('quarter', this)">Quarterly</button>
                    <button class="period-btn" onclick="changeReportPeriod('year', this)">Yearly</button>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>üìä Profit Margin</h3>
                        <div class="value" id="profitMargin">0%</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>üêü Fish Sold</h3>
                        <div class="value" id="fishSold">0</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>üí∞ Average Sale Price</h3>
                        <div class="value" id="avgSalePrice">‚Çπ0</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>üìà Growth Rate</h3>
                        <div class="value" id="growthRate">0%</div>
                    </div>
                </div>

                <div style="text-align: center; padding: 40px; color: #666;">
                    <p>Detailed reports and analytics will be generated based on your data!</p>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">‚öôÔ∏è Settings</h2>
                
                <div class="form-group">
                    <h3 style="margin-bottom: 15px;">üì• Data Management</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="exportData()">üì• Export Data</button>
                        <button class="btn btn-warning" onclick="importData()">üì§ Import Data</button>
                        <button class="btn" style="background: #6c757d; color: white;" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">üë§ Account Information</h3>
                    <p style="color: #666;">Signed in as: <strong id="settingsUserEmail">Loading...</strong></p>
                    <p style="color: #666; margin-top: 10px;">Your data is securely stored in the cloud and synced in real-time.</p>
                </div>

                <div class="form-group" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">üîß System Information</h3>
                    <p style="color: #666;">Version: 2.0 (Multi-User)</p>
                    <p style="color: #666;">Database: Firebase Realtime Database</p>
                    <p style="color: #666;">Authentication: Firebase Auth</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Initialize app data structure
        let appData = {
            transactions: [],
            expenses: [],
            ponds: [
                {id: 1, name: 'Pond 1', capacity: 10000, primaryFishType: 'Gold Fish'},
                {id: 2, name: 'Pond 2', capacity: 8000, primaryFishType: 'Angel Fish'},
                {id: 3, name: 'Pond 3', capacity: 12000, primaryFishType: 'Carp'}
            ],
            stockAdjustments: [],
            fishTypes: ['Gold Fish', 'Angel Fish', 'Black Moors', 'Carp', 'Tetra', 'Guppy', 'Koi', 'Molly', 'Platy', 'Swordtail'],
            expenseCategories: ['Cleaning', 'Feed', 'Medicine', 'Electricity', 'Maintenance', 'Transport', 'Salary', 'Water Treatment', 'Equipment', 'Other'],
            people: [
                {name: 'Arjun', type: 'vendor'},
                {name: 'Ben', type: 'customer'},
                {name: 'Raj', type: 'both'}
            ],
            nextTransactionId: 1,
            nextExpenseId: 1,
            nextPondId: 4,
            nextAdjustmentId: 1,
            currentDashboardPeriod: 'today',
            currentReportPeriod: 'month'
        };

        let fishEntryCount = 1;

        function getDefaultAppData() {
            return {
                transactions: [],
                expenses: [],
                ponds: [
                    {id: 1, name: 'Pond 1', capacity: 10000, primaryFishType: 'Gold Fish'},
                    {id: 2, name: 'Pond 2', capacity: 8000, primaryFishType: 'Angel Fish'},
                    {id: 3, name: 'Pond 3', capacity: 12000, primaryFishType: 'Carp'}
                ],
                stockAdjustments: [],
                fishTypes: ['Gold Fish', 'Angel Fish', 'Black Moors', 'Carp', 'Tetra', 'Guppy', 'Koi', 'Molly', 'Platy', 'Swordtail'],
                expenseCategories: ['Cleaning', 'Feed', 'Medicine', 'Electricity', 'Maintenance', 'Transport', 'Salary', 'Water Treatment', 'Equipment', 'Other'],
                people: [
                    {name: 'Arjun', type: 'vendor'},
                    {name: 'Ben', type: 'customer'},
                    {name: 'Raj', type: 'both'}
                ],
                nextTransactionId: 1,
                nextExpenseId: 1,
                nextPondId: 4,
                nextAdjustmentId: 1,
                currentDashboardPeriod: 'today',
                currentReportPeriod: 'month'
            };
        }

        // Load data from localStorage (fallback)
        function loadData() {
            const savedData = localStorage.getItem('cochinAquaticsDataV2');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    appData = { ...getDefaultAppData(), ...parsed };
                } catch (e) {
                    console.error('Error loading saved data:', e);
                    appData = getDefaultAppData();
                }
            }
            
            // Initialize date fields
            const today = new Date().toISOString().split('T')[0];
            const transactionDateField = document.getElementById('transactionDate');
            const expenseDateField = document.getElementById('expenseDate');
            
            if (transactionDateField) transactionDateField.value = today;
            if (expenseDateField) expenseDateField.value = today;
            
            updateAllDisplays();
        }

        // Save data to localStorage (fallback)
        window.saveData = function() {
            try {
                localStorage.setItem('cochinAquaticsDataV2', JSON.stringify(appData));
                console.log('üíæ Data saved successfully');
                // Also persist to Firebase Realtime Database if signed in
                try {
                    if (window.firebaseAuth && window.firebaseAuth.currentUser && window.firebaseDb) {
                        const uid = window.firebaseAuth.currentUser.uid;
                        window.firebaseDb.ref('users/' + uid + '/appData').set(appData).catch(function(err){
                            console.error('‚ùå Error saving to database:', err);
                        });
                    }
                } catch (e) {
                    console.error('‚ùå DB save wrapper error:', e);
                }
                return true;
            } catch (error) {
                console.error('‚ùå Error saving data:', error);
                return false;
            }
        };

        // Load user data from Realtime Database (if available)
        async function loadUserDataFromDatabase(uid) {
            try {
                if (!window.firebaseDb) return false;
                const snapshot = await window.firebaseDb.ref('users/' + uid + '/appData').once('value');
                const remote = snapshot.val();
                if (remote && typeof remote === 'object') {
                    appData = { ...getDefaultAppData(), ...remote };
                    // Mirror to localStorage for offline usage
                    try { localStorage.setItem('cochinAquaticsDataV2', JSON.stringify(appData)); } catch(_) {}
                    updateAllDisplays();
                    console.log('‚òÅÔ∏è Loaded data from Realtime Database');
                    return true;
                }
                console.log('‚ÑπÔ∏è No remote data found; using local defaults');
                return false;
            } catch (e) {
                console.error('‚ùå Error loading from database:', e);
                return false;
            }
        }

        // Authentication: UI wiring with Firebase Auth (compat)
        document.addEventListener('DOMContentLoaded', function() {
            if (!window.firebaseAuth) {
                console.warn('Firebase Auth not initialized');
                return;
            }

            const auth = window.firebaseAuth;
            const authContainer = document.getElementById('authContainer');
            const appContainer = document.getElementById('appContainer');
            const authSubmit = document.getElementById('authSubmit');
            const toggleAuth = document.getElementById('toggleAuth');
            const logoutBtn = document.getElementById('logoutBtn');
            const authError = document.getElementById('authError');
            const authLoading = document.getElementById('authLoading');
            const emailInput = document.getElementById('authEmail');
            const passwordInput = document.getElementById('authPassword');
            const userEmailSpan = document.getElementById('userEmail');

            let isSignUpMode = false;
            function renderAuthMode() {
                if (authSubmit) authSubmit.textContent = isSignUpMode ? 'Sign Up' : 'Sign In';
                if (toggleAuth) toggleAuth.innerHTML = isSignUpMode
                    ? 'Already have an account? <span>Sign In</span>'
                    : 'Don\'t have an account? <span>Sign Up</span>';
            }
            renderAuthMode();

            if (toggleAuth) {
                toggleAuth.addEventListener('click', function() {
                    isSignUpMode = !isSignUpMode;
                    renderAuthMode();
                });
            }

            if (authSubmit) {
                authSubmit.addEventListener('click', async function(e) {
                    e.preventDefault();
                    if (authError) { authError.style.display = 'none'; authError.textContent = ''; }
                    if (authLoading) authLoading.style.display = 'block';

                    const email = (emailInput && emailInput.value || '').trim();
                    const password = passwordInput && passwordInput.value || '';
                    try {
                        if (isSignUpMode) {
                            await auth.createUserWithEmailAndPassword(email, password);
                        } else {
                            await auth.signInWithEmailAndPassword(email, password);
                        }
                    } catch (err) {
                        if (authError) {
                            authError.textContent = (err && err.message) || 'Authentication failed';
                            authError.style.display = 'block';
                        }
                        console.error('Auth error:', err);
                    } finally {
                        if (authLoading) authLoading.style.display = 'none';
                    }
                });
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function() {
                    try { await auth.signOut(); } catch (e) { console.error('Logout error:', e); }
                });
            }

            auth.onAuthStateChanged(function(user) {
                if (user) {
                    if (authContainer) authContainer.style.display = 'none';
                    if (appContainer) appContainer.style.display = 'block';
                    if (userEmailSpan) userEmailSpan.textContent = user.email || 'User';
                    // Load existing user data from DB, fallback handled inside
                    loadUserDataFromDatabase(user.uid).then(function(loaded){
                        if (!loaded) {
                            updateAllDisplays();
                        }
                    });
                } else {
                    if (appContainer) appContainer.style.display = 'none';
                    if (authContainer) authContainer.style.display = 'block';
                    if (userEmailSpan) userEmailSpan.textContent = '';
                }
            });
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
                const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
                updateAllDisplays();
            }
        }

        // Dashboard period change
        function changeDashboardPeriod(period, btn) {
            appData.currentDashboardPeriod = period;
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            updateDashboard();
        }

        // Report period change
        function changeReportPeriod(period, btn) {
            appData.currentReportPeriod = period;
            document.querySelectorAll('#reports .period-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            updateReports();
        }

        // Update all displays
        function updateAllDisplays() {
            updateDashboard();
            updateReports();
            
            // Update settings email
            const settingsEmail = document.getElementById('settingsUserEmail');
            const userEmailSpan = document.getElementById('userEmail');
            if (settingsEmail && userEmailSpan) {
                settingsEmail.textContent = userEmailSpan.textContent || 'Not signed in';
            }
        }

        // Update dashboard
        function updateDashboard() {
            const totalIncome = appData.transactions
                .filter(t => t.type === 'sale')
                .reduce((sum, t) => sum + (t.totalAmount || 0), 0);
            
            const totalExpenses = appData.expenses
                .reduce((sum, e) => sum + (e.amount || 0), 0);
            
            const netProfit = totalIncome - totalExpenses;
            
            const totalFish = appData.transactions
                .reduce((sum, t) => {
                    if (t.fishDetails) {
                        return sum + t.fishDetails.reduce((fishSum, fish) => fishSum + (fish.quantity || 0), 0);
                    }
                    return sum + (t.quantity || 0);
                }, 0);

            // Update dashboard cards
            const incomeEl = document.getElementById('totalIncome');
            const expensesEl = document.getElementById('totalExpenses');
            const profitEl = document.getElementById('netProfit');
            const fishEl = document.getElementById('totalFish');

            if (incomeEl) incomeEl.textContent = `‚Çπ${totalIncome.toLocaleString()}`;
            if (expensesEl) expensesEl.textContent = `‚Çπ${totalExpenses.toLocaleString()}`;
            if (profitEl) profitEl.textContent = `‚Çπ${netProfit.toLocaleString()}`;
            if (fishEl) fishEl.textContent = totalFish.toLocaleString();

            // Update recent activity
            updateRecentActivity();
        }

        // Update recent activity
        function updateRecentActivity() {
            const recentActivity = document.getElementById('recentActivity');
            if (!recentActivity) return;

            const recentTransactions = appData.transactions.slice(-3).reverse();
            const recentExpenses = appData.expenses.slice(-3).reverse();

            let html = '';
            
            if (recentTransactions.length > 0) {
                html += '<h4 style="color: #1e3c72; margin-bottom: 10px;">Recent Transactions:</h4>';
                recentTransactions.forEach(t => {
                    html += `<p style="margin-bottom: 5px;">‚Ä¢ ${t.type} - ${t.personName} - ‚Çπ${t.totalAmount || 0}</p>`;
                });
            }

            if (recentExpenses.length > 0) {
                html += '<h4 style="color: #1e3c72; margin: 15px 0 10px 0;">Recent Expenses:</h4>';
                recentExpenses.forEach(e => {
                    html += `<p style="margin-bottom: 5px;">‚Ä¢ ${e.category} - ‚Çπ${e.amount || 0}</p>`;
                });
            }

            if (html === '') {
                html = '<p style="color: #666;">No recent activity. Start by adding a transaction or expense!</p>';
            }

            recentActivity.innerHTML = html;
        }

        // Update reports
        function updateReports() {
            const totalIncome = appData.transactions
                .filter(t => t.type === 'sale')
                .reduce((sum, t) => sum + (t.totalAmount || 0), 0);
            
            const totalExpenses = appData.expenses
                .reduce((sum, e) => sum + (e.amount || 0), 0);

            const profitMargin = totalIncome > 0 ? ((totalIncome - totalExpenses) / totalIncome * 100).toFixed(1) : 0;
            const fishSold = appData.transactions
                .filter(t => t.type === 'sale')
                .reduce((sum, t) => sum + (t.quantity || 0), 0);
            const avgSalePrice = fishSold > 0 ? (totalIncome / fishSold).toFixed(2) : 0;

            const profitMarginEl = document.getElementById('profitMargin');
            const fishSoldEl = document.getElementById('fishSold');
            const avgSalePriceEl = document.getElementById('avgSalePrice');
            const growthRateEl = document.getElementById('growthRate');

            if (profitMarginEl) profitMarginEl.textContent = `${profitMargin}%`;
            if (fishSoldEl) fishSoldEl.textContent = fishSold.toLocaleString();
            if (avgSalePriceEl) avgSalePriceEl.textContent = `‚Çπ${avgSalePrice}`;
            if (growthRateEl) growthRateEl.textContent = '0%'; // Placeholder
        }

        // Transaction form functions
        function updateTransactionForm() {
            const type = document.getElementById('transactionType').value;
            const personLabel = document.getElementById('personLabel');
            
            if (personLabel) {
                if (type === 'purchase') {
                    personLabel.textContent = 'Vendor Name';
                } else if (type === 'sale') {
                    personLabel.textContent = 'Customer Name';
                } else if (type === 'trading') {
                    personLabel.textContent = 'Trading Partner Name';
                }
            }
        }

        // Expense form functions
        function updateExpenseForm() {
            const type = document.getElementById('expenseType').value;
            const pondDiv = document.getElementById('pondSelectDiv');
            const employeeDiv = document.getElementById('employeeDiv');
            
            if (pondDiv) pondDiv.style.display = type === 'pond' ? 'block' : 'none';
            if (employeeDiv) employeeDiv.style.display = type === 'salary' ? 'block' : 'none';
        }

        // Calculate totals
        function calculateTotals() {
            let total = 0;
            const fishEntries = document.querySelectorAll('.fish-entry');
            
            fishEntries.forEach(entry => {
                const quantity = parseFloat(entry.querySelector('.fish-quantity').value) || 0;
                const rate = parseFloat(entry.querySelector('.fish-rate').value) || 0;
                total += quantity * rate;
            });

            const totalAmountEl = document.getElementById('totalAmount');
            if (totalAmountEl) {
                totalAmountEl.textContent = total.toFixed(2);
            }
        }

        // Add fish entry
        function addFishEntry() {
            fishEntryCount++;
            const fishEntries = document.getElementById('fishEntries');
            const newEntry = document.createElement('div');
            newEntry.className = 'fish-entry';
            newEntry.innerHTML = `
                <h4>üêü Fish Details #${fishEntryCount}</h4>
                <div class="row">
                    <div class="form-group">
                        <label>Fish Type</label>
                        <select class="fish-type" required onchange="calculateTotals()">
                            <option value="">Select Fish</option>
                            <option value="Gold Fish">Gold Fish</option>
                            <option value="Angel Fish">Angel Fish</option>
                            <option value="Black Moors">Black Moors</option>
                            <option value="Carp">Carp</option>
                            <option value="Tetra">Tetra</option>
                            <option value="Guppy">Guppy</option>
                            <option value="Koi">Koi</option>
                            <option value="Molly">Molly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" class="fish-quantity" placeholder="e.g., 1000" required onchange="calculateTotals()">
                    </div>
                    <div class="form-group">
                        <label>Rate per Fish (‚Çπ)</label>
                        <input type="number" step="0.01" class="fish-rate" placeholder="e.g., 1.5" required onchange="calculateTotals()">
                    </div>
                </div>
                <div class="pond-section">
                    <label>Assign to Pond</label>
                    <div class="pond-distribution">
                        <select class="pond-select">
                            <option value="">Select Pond</option>
                            <option value="1">Pond 1</option>
                            <option value="2">Pond 2</option>
                            <option value="3">Pond 3</option>
                        </select>
                        <input type="number" class="pond-quantity" placeholder="Quantity">
                    </div>
                </div>
            `;
            fishEntries.appendChild(newEntry);
        }

        // Data management functions
        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `cochin-aquatics-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        appData = { ...getDefaultAppData(), ...imported };
                        saveData();
                        updateAllDisplays();
                        alert('‚úÖ Data imported successfully!');
                    } catch (error) {
                        alert('‚ùå Error importing data. Please check the file.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear all data? This cannot be undone!')) {
                if (confirm('‚ö†Ô∏è This will delete everything! Are you really sure?')) {
                    appData = getDefaultAppData();
                    saveData();
                    updateAllDisplays();
                    alert('‚úÖ All data cleared successfully!');
                }
            }
        }

        // Initialize app on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üêü Cochin Aquatics System v2.0 - Initializing...');
            
            try {
                // Initialize data
                loadData();
                
                // Set up tab switching
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        const tabName = this.getAttribute('data-tab');
                        switchTab(tabName);
                    });
                });

                // Transaction form submission
                const transactionForm = document.getElementById('transactionForm');
                if (transactionForm) {
                    transactionForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        // Collect fish details
                        const fishDetails = [];
                        const fishEntries = document.querySelectorAll('.fish-entry');
                        
                        fishEntries.forEach((entry, index) => {
                            const fishType = entry.querySelector('.fish-type').value;
                            const quantity = parseFloat(entry.querySelector('.fish-quantity').value) || 0;
                            const rate = parseFloat(entry.querySelector('.fish-rate').value) || 0;
                            const pondId = entry.querySelector('.pond-select').value;
                            const pondQuantity = parseFloat(entry.querySelector('.pond-quantity').value) || quantity;
                            
                            if (fishType && quantity && rate) {
                                fishDetails.push({
                                    type: fishType,
                                    quantity: quantity,
                                    rate: rate,
                                    pondId: pondId,
                                    pondQuantity: pondQuantity,
                                    amount: quantity * rate
                                });
                            }
                        });

                        if (fishDetails.length === 0) {
                            alert('Please add at least one fish entry.');
                            return;
                        }

                        const transaction = {
                            id: appData.nextTransactionId++,
                            date: document.getElementById('transactionDate').value,
                            type: document.getElementById('transactionType').value,
                            personName: document.getElementById('personName').value,
                            fishDetails: fishDetails,
                            totalAmount: fishDetails.reduce((sum, fish) => sum + fish.amount, 0),
                            notes: document.getElementById('transactionNotes').value
                        };

                        appData.transactions.push(transaction);
                        saveData();
                        
                        // Show success message
                        const successMsg = document.getElementById('transactionSuccess');
                        if (successMsg) {
                            successMsg.style.display = 'block';
                            setTimeout(() => {
                                successMsg.style.display = 'none';
                            }, 3000);
                        }
                        
                        // Reset form
                        this.reset();
                        document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
                        
                        // Reset fish entries
                        const fishEntriesDiv = document.getElementById('fishEntries');
                        fishEntriesDiv.innerHTML = `
                            <div class="fish-entry">
                                <h4>üêü Fish Details #1</h4>
                                <div class="row">
                                    <div class="form-group">
                                        <label>Fish Type</label>
                                        <select class="fish-type" required onchange="calculateTotals()">
                                            <option value="">Select Fish</option>
                                            <option value="Gold Fish">Gold Fish</option>
                                            <option value="Angel Fish">Angel Fish</option>
                                            <option value="Black Moors">Black Moors</option>
                                            <option value="Carp">Carp</option>
                                            <option value="Tetra">Tetra</option>
                                            <option value="Guppy">Guppy</option>
                                            <option value="Koi">Koi</option>
                                            <option value="Molly">Molly</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Quantity</label>
                                        <input type="number" class="fish-quantity" placeholder="e.g., 1000" required onchange="calculateTotals()">
                                    </div>
                                    <div class="form-group">
                                        <label>Rate per Fish (‚Çπ)</label>
                                        <input type="number" step="0.01" class="fish-rate" placeholder="e.g., 1.5" required onchange="calculateTotals()">
                                    </div>
                                </div>
                                <div class="pond-section">
                                    <label>Assign to Pond</label>
                                    <div class="pond-distribution">
                                        <select class="pond-select">
                                            <option value="">Select Pond</option>
                                            <option value="1">Pond 1</option>
                                            <option value="2">Pond 2</option>
                                            <option value="3">Pond 3</option>
                                        </select>
                                        <input type="number" class="pond-quantity" placeholder="Quantity">
                                    </div>
                                </div>
                            </div>
                        `;
                        fishEntryCount = 1;
                        calculateTotals();
                        
                        updateAllDisplays();
                    });
                }

                // Expense form submission
                const expenseForm = document.getElementById('expenseForm');
                if (expenseForm) {
                    expenseForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const expense = {
                            id: appData.nextExpenseId++,
                            date: document.getElementById('expenseDate').value,
                            type: document.getElementById('expenseType').value,
                            pondId: document.getElementById('expensePond').value,
                            employeeName: document.getElementById('employeeName').value,
                            category: document.getElementById('expenseCategory').value,
                            amount: parseFloat(document.getElementById('expenseAmount').value),
                            description: document.getElementById('expenseDescription').value
                        };

                        appData.expenses.push(expense);
                        saveData();
                        
                        // Show success message
                        const successMsg = document.getElementById('expenseSuccess');
                        if (successMsg) {
                            successMsg.style.display = 'block';
                            setTimeout(() => {
                                successMsg.style.display = 'none';
                            }, 3000);
                        }
                        
                        // Reset form
                        this.reset();
                        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
                        document.getElementById('pondSelectDiv').style.display = 'none';
                        document.getElementById('employeeDiv').style.display = 'none';
                        
                        updateAllDisplays();
                    });
                }

                console.log('‚úÖ System initialized successfully!');
                
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                alert('‚ö†Ô∏è There was an error loading the system. Please refresh the page.');
            }
        });

        // Add global error handler
        window.addEventListener('error', function(e) {
            console.error('‚ùå JavaScript Error:', e.error);
        });
    </script>
</body>
</html>