<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cochin Aquatics Management System v2.0 - Multi-User</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Authentication Styles */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            text-align: center;
        }

        .auth-title {
            color: #1e3c72;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .auth-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .auth-input {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .auth-input:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .auth-btn {
            padding: 15px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
        }

        .auth-toggle {
            margin-top: 20px;
            color: #666;
            cursor: pointer;
        }

        .auth-toggle span {
            color: #1e3c72;
            font-weight: 600;
        }

        .user-info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 14px;
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 15px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 80px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .version-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            color: #1e3c72;
            border-bottom: 3px solid #1e3c72;
            background: white;
        }

        .content {
            padding: 20px;
            min-height: 400px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .period-selector {
            display: inline-flex;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .period-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .period-btn.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="date"] {
            cursor: pointer;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-card.success {
            border-left-color: #38ef7d;
        }

        .stat-card.danger {
            border-left-color: #f5576c;
        }

        .stat-card.warning {
            border-left-color: #ffa726;
        }

        .transaction-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .transaction-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .transaction-item:hover {
            background: #f8f9fa;
        }

        .transaction-type {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .type-purchase {
            background: #e3f2fd;
            color: #1976d2;
        }

        .type-sale {
            background: #e8f5e9;
            color: #388e3c;
        }

        .type-trading {
            background: #fff3e0;
            color: #f57c00;
        }

        .type-expense {
            background: #ffebee;
            color: #c62828;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                flex-shrink: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .success-message {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message.show {
            display: block;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div id="authContainer" class="auth-container">
        <h2 class="auth-title">🐟 Cochin Aquatics</h2>
        <p class="auth-subtitle">Sign in to access your business management system</p>
        <div id="authForm" class="auth-form">
            <input type="email" id="authEmail" class="auth-input" placeholder="Email Address" required>
            <input type="password" id="authPassword" class="auth-input" placeholder="Password" required>
            <button id="authSubmit" class="auth-btn">Sign In</button>
            <div class="auth-toggle" id="toggleAuth">
                Don't have an account? <span>Sign Up</span>
            </div>
        </div>
        <div id="authError" style="color: #dc3545; margin-top: 15px; display: none; padding: 10px; background: #f8d7da; border-radius: 5px;"></div>
        <div id="authLoading" style="display: none; margin-top: 15px; color: #1e3c72;">
            <div class="loading-spinner"></div> Please wait...
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="appContainer" class="container" style="display: none;">
        <div class="header">
            <div class="user-info" id="userInfo">
                👤 <span id="userEmail"></span>
            </div>
            <button id="logoutBtn" class="logout-btn">🚪 Logout</button>
            <h1>🐟 Cochin Aquatics Management System</h1>
            <div class="subtitle">Multi-User • Real-Time • Cloud-Powered</div>
            <div class="version-badge">v2.0</div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="dashboard">📊 Dashboard</button>
            <button class="tab" data-tab="settings">⚙️ Settings</button>
        </div>

        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">Financial Overview</h2>
                
                <div class="period-selector">
                    <button class="period-btn active" onclick="changeDashboardPeriod('today', this)">Today</button>
                    <button class="period-btn" onclick="changeDashboardPeriod('week', this)">This Week</button>
                    <button class="period-btn" onclick="changeDashboardPeriod('month', this)">This Month</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card success">
                        <h3>💰 <span id="periodLabel">Today's</span> Income</h3>
                        <div class="value" id="periodIncome">₹0</div>
                    </div>
                    <div class="stat-card danger">
                        <h3>💸 <span id="periodLabelExpense">Today's</span> Expense</h3>
                        <div class="value" id="periodExpense">₹0</div>
                    </div>
                    <div class="stat-card warning">
                        <h3>📈 <span id="periodLabelProfit">Today's</span> Profit</h3>
                        <div class="value" id="periodProfit">₹0</div>
                    </div>
                    <div class="stat-card">
                        <h3>🐟 Active Ponds</h3>
                        <div class="value" id="activePonds">0</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 15px; color: #2c3e50;">Recent Transactions</h3>
                <div class="transaction-list" id="recentTransactions">
                    <div class="empty-state">
                        <div class="icon">📋</div>
                        <p>No transactions yet. Start by adding a new transaction!</p>
                    </div>
                </div>

                <!-- Simple Add Transaction Form -->
                <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">Quick Add Transaction</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>Type</label>
                            <select id="quickTransactionType">
                                <option value="sale">💰 Sale</option>
                                <option value="purchase">🛒 Purchase</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount (₹)</label>
                            <input type="number" id="quickAmount" placeholder="Enter amount">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" id="quickDescription" placeholder="Brief description">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addQuickTransaction()">💾 Add Transaction</button>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">Settings & Configuration</h2>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">🐟 Manage Fish Types</h3>
                    <div class="form-group">
                        <label>Add New Fish Type</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="newFishType" placeholder="Enter fish name">
                            <button class="btn btn-success" onclick="addFishType()">Add</button>
                        </div>
                    </div>
                    <div id="fishTypesList" style="margin-top: 15px;">
                        <!-- Fish types will be listed here -->
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">👥 Manage Customers & Vendors</h3>
                    <div class="form-group">
                        <label>Add New Person</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="newPersonInput" placeholder="Enter name">
                            <select id="personType">
                                <option value="customer">Customer</option>
                                <option value="vendor">Vendor</option>
                                <option value="both">Both</option>
                            </select>
                            <button class="btn btn-success" onclick="addPerson()">Add</button>
                        </div>
                    </div>
                    <div id="peopleList" style="margin-top: 15px;">
                        <!-- People will be listed here -->
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">🏊 Manage Ponds</h3>
                    <div class="form-group">
                        <label>Add New Pond</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr 2fr 1fr; gap: 10px;">
                            <input type="text" id="newPondName" placeholder="Pond name">
                            <input type="number" id="newPondCapacity" placeholder="Capacity">
                            <select id="newPondFishType">
                                <option value="">Fish type</option>
                            </select>
                            <button class="btn btn-success" onclick="addPond()">Add</button>
                        </div>
                    </div>
                    <div id="pondsList" style="margin-top: 15px;">
                        <!-- Ponds will be listed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== COMPLETE UNIFIED DATA MANAGEMENT SYSTEM =====
        
        // Global state management
        let appData = null;
        let currentUser = null;
        let isAuthenticated = false;

        // Default data structure
        function getDefaultAppData() {
            return {
                transactions: [],
                expenses: [],
                ponds: [
                    {id: 1, name: 'Pond 1', capacity: 10000, primaryFishType: 'Gold Fish'},
                    {id: 2, name: 'Pond 2', capacity: 8000, primaryFishType: 'Angel Fish'},
                    {id: 3, name: 'Pond 3', capacity: 12000, primaryFishType: 'Carp'}
                ],
                fishTypes: ['Gold Fish', 'Angel Fish', 'Black Moors', 'Carp', 'Tetra', 'Guppy', 'Koi', 'Molly', 'Platy', 'Swordtail'],
                people: [
                    {name: 'Arjun', type: 'vendor'},
                    {name: 'Ben', type: 'customer'},
                    {name: 'Raj', type: 'both'}
                ],
                nextTransactionId: 1,
                nextExpenseId: 1,
                nextPondId: 4,
                currentDashboardPeriod: 'today'
            };
        }

        // ===== UNIFIED SAVE/LOAD SYSTEM =====
        async function unifiedSaveData() {
            console.log('💾 Unified save starting...');
            
            if (!appData) {
                console.error('❌ No appData to save');
                return false;
            }

            // Always save to localStorage first
            try {
                localStorage.setItem('cochinAquaticsDataV2', JSON.stringify(appData));
                console.log('✅ Local save successful');
            } catch (error) {
                console.error('❌ Local save failed:', error);
            }

            // Save to Firebase if authenticated
            if (currentUser && currentUser.uid) {
                try {
                    console.log(`☁️ Saving to Firebase for user: ${currentUser.uid}`);
                    const userRef = firebase.database().ref(`users/${currentUser.uid}/aquaticsData`);
                    await userRef.set(appData);
                    console.log('✅ Firebase save successful');
                    
                    // Force UI update after successful save
                    forceUIUpdate();
                    return true;
                } catch (error) {
                    console.error('❌ Firebase save failed:', error);
                    return false;
                }
            }
            
            // Force UI update even for local-only saves
            forceUIUpdate();
            return true;
        }

        async function unifiedLoadData() {
            console.log('📥 Unified load starting...');

            if (currentUser && currentUser.uid) {
                try {
                    console.log(`☁️ Loading from Firebase for user: ${currentUser.uid}`);
                    const userRef = firebase.database().ref(`users/${currentUser.uid}/aquaticsData`);
                    const snapshot = await userRef.once('value');
                    const firebaseData = snapshot.val();

                    if (firebaseData && typeof firebaseData === 'object') {
                        console.log('✅ Firebase data loaded');
                        console.log(`📊 Found: ${firebaseData.transactions?.length || 0} transactions, ${firebaseData.expenses?.length || 0} expenses`);
                        
                        // Complete replacement with Firebase data
                        appData = { ...getDefaultAppData(), ...firebaseData };
                        
                        // Force UI update
                        forceUIUpdate();
                        
                        // Save to localStorage as backup
                        try {
                            localStorage.setItem('cochinAquaticsDataV2', JSON.stringify(appData));
                        } catch (e) {
                            console.warn('⚠️ localStorage backup failed');
                        }
                        
                        return true;
                    }
                } catch (error) {
                    console.error('❌ Firebase load failed:', error);
                }
            }

            // Fallback to localStorage
            try {
                const localData = localStorage.getItem('cochinAquaticsDataV2');
                if (localData) {
                    const parsed = JSON.parse(localData);
                    appData = { ...getDefaultAppData(), ...parsed };
                    console.log('💾 Local data loaded');
                    forceUIUpdate();
                    return true;
                }
            } catch (error) {
                console.error('❌ Local load failed:', error);
            }

            // Last resort: default data
            console.log('🔧 Using default data');
            appData = getDefaultAppData();
            forceUIUpdate();
            return false;
        }

        // ===== FORCE UI UPDATE SYSTEM =====
        function forceUIUpdate() {
            console.log('🔄 Force UI update triggered');
            
            if (!appData) {
                console.error('❌ No appData for UI update');
                return;
            }

            try {
                updateDashboard();
                updateAllDropdowns();
                updateSettingsLists();
                console.log('✅ UI update complete');
            } catch (error) {
                console.error('❌ UI update failed:', error);
            }
        }

        // ===== DASHBOARD UPDATE SYSTEM =====
        function updateDashboard() {
            if (!appData) return;

            const { startDate, endDate } = getDateRange(appData.currentDashboardPeriod);
            let totalIncome = 0;
            let totalExpense = 0;

            // Calculate from transactions
            (appData.transactions || []).forEach(t => {
                const tDate = new Date(t.date);
                if (tDate >= startDate && tDate < endDate) {
                    if (t.type === 'sale') {
                        totalIncome += t.totalAmount || 0;
                    } else if (t.type === 'purchase') {
                        totalExpense += t.totalAmount || 0;
                    }
                }
            });

            // Calculate from expenses
            (appData.expenses || []).forEach(e => {
                const eDate = new Date(e.date);
                if (eDate >= startDate && eDate < endDate) {
                    totalExpense += e.amount || 0;
                }
            });

            const profit = totalIncome - totalExpense;

            // Update period labels
            const periodText = appData.currentDashboardPeriod === 'today' ? "Today's" : 
                              appData.currentDashboardPeriod === 'week' ? "This Week's" : "This Month's";

            const elements = {
                periodLabel: document.getElementById('periodLabel'),
                periodLabelExpense: document.getElementById('periodLabelExpense'),
                periodLabelProfit: document.getElementById('periodLabelProfit'),
                periodIncome: document.getElementById('periodIncome'),
                periodExpense: document.getElementById('periodExpense'),
                periodProfit: document.getElementById('periodProfit'),
                activePonds: document.getElementById('activePonds')
            };

            // Safe updates with null checks
            if (elements.periodLabel) elements.periodLabel.textContent = periodText;
            if (elements.periodLabelExpense) elements.periodLabelExpense.textContent = periodText;
            if (elements.periodLabelProfit) elements.periodLabelProfit.textContent = periodText;
            if (elements.periodIncome) elements.periodIncome.textContent = `₹${totalIncome.toLocaleString('en-IN')}`;
            if (elements.periodExpense) elements.periodExpense.textContent = `₹${totalExpense.toLocaleString('en-IN')}`;
            if (elements.periodProfit) elements.periodProfit.textContent = `₹${profit.toLocaleString('en-IN')}`;
            if (elements.activePonds) elements.activePonds.textContent = (appData.ponds || []).length;

            console.log(`💰 Dashboard updated: Income ₹${totalIncome}, Expense ₹${totalExpense}, Profit ₹${profit}`);

            updateRecentTransactions();
        }

        function updateRecentTransactions() {
            const container = document.getElementById('recentTransactions');
            if (!container) return;

            const allItems = [
                ...(appData.transactions || []).map(t => ({...t, category: 'transaction'})),
                ...(appData.expenses || []).map(e => ({...e, category: 'expense'}))
            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);

            if (allItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📋</div>
                        <p>No transactions yet. Start by adding a new transaction!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allItems.map(item => {
                if (item.category === 'transaction') {
                    return `
                        <div class="transaction-item">
                            <div>
                                <strong>${item.description || 'Transaction'}</strong><br>
                                <small>${new Date(item.date).toLocaleDateString('en-IN')}</small>
                            </div>
                            <div>
                                <span class="transaction-type type-${item.type}">${item.type}</span>
                                <strong>₹${item.totalAmount.toLocaleString('en-IN')}</strong>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="transaction-item">
                            <div>
                                <strong>${item.description || 'Expense'}</strong><br>
                                <small>${new Date(item.date).toLocaleDateString('en-IN')}</small>
                            </div>
                            <div>
                                <span class="transaction-type type-expense">expense</span>
                                <strong>₹${item.amount.toLocaleString('en-IN')}</strong>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // ===== QUICK TRANSACTION SYSTEM =====
        async function addQuickTransaction() {
            const type = document.getElementById('quickTransactionType').value;
            const amount = parseFloat(document.getElementById('quickAmount').value);
            const description = document.getElementById('quickDescription').value;

            if (!amount || amount <= 0) {
                alert('Please enter a valid amount!');
                return;
            }

            const transaction = {
                id: appData.nextTransactionId++,
                date: new Date().toISOString().split('T')[0],
                type: type,
                totalAmount: amount,
                description: description || `${type} transaction`,
                fishDetails: []
            };

            appData.transactions.push(transaction);
            console.log(`✅ Added ${type} transaction: ₹${amount}`);

            const saved = await unifiedSaveData();
            if (saved) {
                document.getElementById('quickAmount').value = '';
                document.getElementById('quickDescription').value = '';
                console.log('✅ Transaction saved successfully');
            }
        }
                // ===== COMPLETE UNIFIED DATA MANAGEMENT SYSTEM =====
        
        // Global state management
        let appData = null;
        let currentUser = null;
        let isAuthenticated = false;

        // Default data structure
        function getDefaultAppData() {
            return {
                transactions: [],
                expenses: [],
                ponds: [
                    {id: 1, name: 'Pond 1', capacity: 10000, primaryFishType: 'Gold Fish'},
                    {id: 2, name: 'Pond 2', capacity: 8000, primaryFishType: 'Angel Fish'},
                    {id: 3, name: 'Pond 3', capacity: 12000, primaryFishType: 'Carp'}
                ],
                fishTypes: ['Gold Fish', 'Angel Fish', 'Black Moors', 'Carp', 'Tetra', 'Guppy', 'Koi', 'Molly', 'Platy', 'Swordtail'],
                people: [
                    {name: 'Arjun', type: 'vendor'},
                    {name: 'Ben', type: 'customer'},
                    {name: 'Raj', type: 'both'}
                ],
                nextTransactionId: 1,
                nextExpenseId: 1,
                nextPondId: 4,
                currentDashboardPeriod: 'today'
            };
        }

        // ===== UNIFIED SAVE/LOAD SYSTEM =====
        async function unifiedSaveData() {
            console.log('💾 Unified save starting...');
            
            if (!appData) {
                console.error('❌ No appData to save');
                return false;
            }

            // Always save to localStorage first
            try {
                localStorage.setItem('cochinAquaticsDataV2', JSON.stringify(appData));
                console.log('✅ Local save successful');
            } catch (error) {
                console.error('❌ Local save failed:', error);
            }

            // Save to Firebase if authenticated
            if (currentUser && currentUser.uid) {
                try {
                    console.log(`☁️ Saving to Firebase for user: ${currentUser.uid}`);
                    const userRef = firebase.database().ref(`users/${currentUser.uid}/aquaticsData`);
                    await userRef.set(appData);
                    console.log('✅ Firebase save successful');
                    
                    // Force UI update after successful save
                    forceUIUpdate();
                    return true;
                } catch (error) {
                    console.error('❌ Firebase save failed:', error);
                    return false;
                }
            }
            
            // Force UI update even for local-only saves
            forceUIUpdate();
            return true;
        }

        async function unifiedLoadData() {
            console.log('📥 Unified load starting...');

            if (currentUser && currentUser.uid) {
                try {
                    console.log(`☁️ Loading from Firebase for user: ${currentUser.uid}`);
                    const userRef = firebase.database().ref(`users/${currentUser.uid}/aquaticsData`);
                    const snapshot = await userRef.once('value');
                    const firebaseData = snapshot.val();

                    if (firebaseData && typeof firebaseData === 'object') {
                        console.log('✅ Firebase data loaded');
                        console.log(`📊 Found: ${firebaseData.transactions?.length || 0} transactions, ${firebaseData.expenses?.length || 0} expenses`);
                        
                        // Complete replacement with Firebase data
                        appData = { ...getDefaultAppData(), ...firebaseData };
                        
                        // Force UI update
                        forceUIUpdate();
                        
                        // Save to localStorage as backup
                        try {
                            localStorage.setItem('cochinAquaticsDataV2', JSON.stringify(appData));
                        } catch (e) {
                            console.warn('⚠️ localStorage backup failed');
                        }
                        
                        return true;
                    }
                } catch (error) {
                    console.error('❌ Firebase load failed:', error);
                }
            }

            // Fallback to localStorage
            try {
                const localData = localStorage.getItem('cochinAquaticsDataV2');
                if (localData) {
                    const parsed = JSON.parse(localData);
                    appData = { ...getDefaultAppData(), ...parsed };
                    console.log('💾 Local data loaded');
                    forceUIUpdate();
                    return true;
                }
            } catch (error) {
                console.error('❌ Local load failed:', error);
            }

            // Last resort: default data
            console.log('🔧 Using default data');
            appData = getDefaultAppData();
            forceUIUpdate();
            return false;
        }

        // ===== FORCE UI UPDATE SYSTEM =====
        function forceUIUpdate() {
            console.log('🔄 Force UI update triggered');
            
            if (!appData) {
                console.error('❌ No appData for UI update');
                return;
            }

            try {
                updateDashboard();
                updateAllDropdowns();
                updateSettingsLists();
                console.log('✅ UI update complete');
            } catch (error) {
                console.error('❌ UI update failed:', error);
            }
        }

        // ===== DASHBOARD UPDATE SYSTEM =====
        function updateDashboard() {
            if (!appData) return;

            const { startDate, endDate } = getDateRange(appData.currentDashboardPeriod);
            let totalIncome = 0;
            let totalExpense = 0;

            // Calculate from transactions
            (appData.transactions || []).forEach(t => {
                const tDate = new Date(t.date);
                if (tDate >= startDate && tDate < endDate) {
                    if (t.type === 'sale') {
                        totalIncome += t.totalAmount || 0;
                    } else if (t.type === 'purchase') {
                        totalExpense += t.totalAmount || 0;
                    }
                }
            });

            // Calculate from expenses
            (appData.expenses || []).forEach(e => {
                const eDate = new Date(e.date);
                if (eDate >= startDate && eDate < endDate) {
                    totalExpense += e.amount || 0;
                }
            });

            const profit = totalIncome - totalExpense;

            // Update period labels
            const periodText = appData.currentDashboardPeriod === 'today' ? "Today's" : 
                              appData.currentDashboardPeriod === 'week' ? "This Week's" : "This Month's";

            const elements = {
                periodLabel: document.getElementById('periodLabel'),
                periodLabelExpense: document.getElementById('periodLabelExpense'),
                periodLabelProfit: document.getElementById('periodLabelProfit'),
                periodIncome: document.getElementById('periodIncome'),
                periodExpense: document.getElementById('periodExpense'),
                periodProfit: document.getElementById('periodProfit'),
                activePonds: document.getElementById('activePonds')
            };

            // Safe updates with null checks
            if (elements.periodLabel) elements.periodLabel.textContent = periodText;
            if (elements.periodLabelExpense) elements.periodLabelExpense.textContent = periodText;
            if (elements.periodLabelProfit) elements.periodLabelProfit.textContent = periodText;
            if (elements.periodIncome) elements.periodIncome.textContent = `₹${totalIncome.toLocaleString('en-IN')}`;
            if (elements.periodExpense) elements.periodExpense.textContent = `₹${totalExpense.toLocaleString('en-IN')}`;
            if (elements.periodProfit) elements.periodProfit.textContent = `₹${profit.toLocaleString('en-IN')}`;
            if (elements.activePonds) elements.activePonds.textContent = (appData.ponds || []).length;

            console.log(`💰 Dashboard updated: Income ₹${totalIncome}, Expense ₹${totalExpense}, Profit ₹${profit}`);

            updateRecentTransactions();
        }

        function updateRecentTransactions() {
            const container = document.getElementById('recentTransactions');
            if (!container) return;

            const allItems = [
                ...(appData.transactions || []).map(t => ({...t, category: 'transaction'})),
                ...(appData.expenses || []).map(e => ({...e, category: 'expense'}))
            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);

            if (allItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📋</div>
                        <p>No transactions yet. Start by adding a new transaction!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allItems.map(item => {
                if (item.category === 'transaction') {
                    return `
                        <div class="transaction-item">
                            <div>
                                <strong>${item.description || 'Transaction'}</strong><br>
                                <small>${new Date(item.date).toLocaleDateString('en-IN')}</small>
                            </div>
                            <div>
                                <span class="transaction-type type-${item.type}">${item.type}</span>
                                <strong>₹${item.totalAmount.toLocaleString('en-IN')}</strong>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="transaction-item">
                            <div>
                                <strong>${item.description || 'Expense'}</strong><br>
                                <small>${new Date(item.date).toLocaleDateString('en-IN')}</small>
                            </div>
                            <div>
                                <span class="transaction-type type-expense">expense</span>
                                <strong>₹${item.amount.toLocaleString('en-IN')}</strong>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // ===== QUICK TRANSACTION SYSTEM =====
        async function addQuickTransaction() {
            const type = document.getElementById('quickTransactionType').value;
            const amount = parseFloat(document.getElementById('quickAmount').value);
            const description = document.getElementById('quickDescription').value;

            if (!amount || amount <= 0) {
                alert('Please enter a valid amount!');
                return;
            }

            const transaction = {
                id: appData.nextTransactionId++,
                date: new Date().toISOString().split('T')[0],
                type: type,
                totalAmount: amount,
                description: description || `${type} transaction`,
                fishDetails: []
            };

            appData.transactions.push(transaction);
            console.log(`✅ Added ${type} transaction: ₹${amount}`);

            const saved = await unifiedSaveData();
            if (saved) {
                document.getElementById('quickAmount').value = '';
                document.getElementById('quickDescription').value = '';
                console.log('✅ Transaction saved successfully');
            }
        }
✅ CHUNK 3 COMPLETE!
Copy the code above and paste it directly after the <script> tag from Chunk 2.

This chunk contains all the core data management, dashboard updates, and transaction functions.

Ready for CHUNK 4? Reply with "NEXT" and I'll give you the settings management functions! 🚀

NEXT
📦 CHUNK 4 of 5: JavaScript Settings & Authentication (Part 2)
Perfect! Now copy this chunk and paste it right after Chunk 3:

        // ===== SETTINGS MANAGEMENT SYSTEM =====
        async function addFishType() {
            const input = document.getElementById('newFishType');
            const fishType = input.value.trim();
            
            if (fishType && !appData.fishTypes.includes(fishType)) {
                appData.fishTypes.push(fishType);
                console.log(`🐟 Added fish type: ${fishType}`);
                
                const saved = await unifiedSaveData();
                if (saved) {
                    input.value = '';
                    console.log('✅ Fish type saved successfully');
                }
            }
        }

        async function removeFishType(fishType) {
            appData.fishTypes = appData.fishTypes.filter(f => f !== fishType);
            console.log(`🗑️ Removed fish type: ${fishType}`);
            await unifiedSaveData();
        }

        async function addPerson() {
            const nameInput = document.getElementById('newPersonInput');
            const typeSelect = document.getElementById('personType');
            const name = nameInput.value.trim();
            
            if (name && !appData.people.find(p => p.name === name)) {
                appData.people.push({
                    name: name,
                    type: typeSelect.value
                });
                console.log(`👥 Added person: ${name} (${typeSelect.value})`);
                
                const saved = await unifiedSaveData();
                if (saved) {
                    nameInput.value = '';
                    console.log('✅ Person saved successfully');
                }
            }
        }

        async function removePerson(name) {
            appData.people = appData.people.filter(p => p.name !== name);
            console.log(`🗑️ Removed person: ${name}`);
            await unifiedSaveData();
        }

        async function addPond() {
            const nameInput = document.getElementById('newPondName');
            const capacityInput = document.getElementById('newPondCapacity');
            const fishTypeSelect = document.getElementById('newPondFishType');
            
            const name = nameInput.value.trim();
            const capacity = parseInt(capacityInput.value) || 0;
            const fishType = fishTypeSelect.value;
            
            if (name) {
                const pond = {
                    id: appData.nextPondId++,
                    name: name,
                    capacity: capacity,
                    primaryFishType: fishType
                };
                
                appData.ponds.push(pond);
                console.log(`🏊 Added pond: ${name}`);
                
                const saved = await unifiedSaveData();
                if (saved) {
                    nameInput.value = '';
                    capacityInput.value = '';
                    fishTypeSelect.value = '';
                    console.log('✅ Pond saved successfully');
                }
            }
        }

        async function removePond(pondId) {
            appData.ponds = appData.ponds.filter(p => p.id !== pondId);
            console.log(`🗑️ Removed pond: ${pondId}`);
            await unifiedSaveData();
        }

        // ===== DROPDOWN UPDATE SYSTEM =====
        function updateAllDropdowns() {
            updateFishTypeDropdowns();
        }

        function updateFishTypeDropdowns() {
            const pondFishSelect = document.getElementById('newPondFishType');
            if (pondFishSelect) {
                pondFishSelect.innerHTML = `
                    <option value="">Select Fish Type</option>
                    ${(appData.fishTypes || []).map(f => `<option value="${f}">${f}</option>`).join('')}
                `;
            }
        }

        // ===== SETTINGS LISTS UPDATE =====
        function updateSettingsLists() {
            updateFishTypesList();
            updatePeopleList();
            updatePondsList();
        }

        function updateFishTypesList() {
            const fishTypesList = document.getElementById('fishTypesList');
            if (fishTypesList) {
                fishTypesList.innerHTML = (appData.fishTypes || []).map(f => `
                    <div style="padding: 5px; background: white; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between;">
                        <span>🐟 ${f}</span>
                        <button class="remove-btn" onclick="removeFishType('${f}')">Remove</button>
                    </div>
                `).join('');
            }
        }

        function updatePeopleList() {
            const peopleList = document.getElementById('peopleList');
            if (peopleList) {
                peopleList.innerHTML = (appData.people || []).map(p => `
                    <div style="padding: 5px; background: white; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between;">
                        <span>👤 ${p.name} (${p.type})</span>
                        <button class="remove-btn" onclick="removePerson('${p.name}')">Remove</button>
                    </div>
                `).join('');
            }
        }

        function updatePondsList() {
            const pondsList = document.getElementById('pondsList');
            if (pondsList) {
                pondsList.innerHTML = (appData.ponds || []).map(p => `
                    <div style="padding: 5px; background: white; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between;">
                        <span>🏊 ${p.name} (${p.capacity} capacity, ${p.primaryFishType})</span>
                        <button class="remove-btn" onclick="removePond(${p.id})">Remove</button>
                    </div>
                `).join('');
            }
        }

        // ===== AUTHENTICATION SYSTEM =====
        function initializeAuth() {
            console.log('🔐 Initializing authentication...');
            
            firebase.auth().onAuthStateChanged(async (user) => {
                const authContainer = document.getElementById('authContainer');
                const appContainer = document.getElementById('appContainer');
                const userEmailElement = document.getElementById('userEmail');
                
                if (user) {
                    console.log(`✅ User authenticated: ${user.email}`);
                    currentUser = user;
                    isAuthenticated = true;
                    
                    if (authContainer) authContainer.style.display = 'none';
                    if (appContainer) appContainer.style.display = 'block';
                    if (userEmailElement) userEmailElement.textContent = user.email;
                    
                    // Load user data
                    await unifiedLoadData();
                    
                } else {
                    console.log('❌ User not authenticated');
                    currentUser = null;
                    isAuthenticated = false;
                    
                    if (authContainer) authContainer.style.display = 'block';
                    if (appContainer) appContainer.style.display = 'none';
                    
                    // Load default/local data when not authenticated
                    appData = getDefaultAppData();
                    forceUIUpdate();
                }
            });
            
            setupAuthForm();
        }

        function setupAuthForm() {
            let isSignUp = false;
            
            const authSubmit = document.getElementById('authSubmit');
            const toggleAuth = document.getElementById('toggleAuth');
            
            if (toggleAuth) {
                toggleAuth.onclick = () => {
                    isSignUp = !isSignUp;
                    if (authSubmit) {
                        authSubmit.textContent = isSignUp ? 'Sign Up' : 'Sign In';
                    }
                    toggleAuth.innerHTML = isSignUp ? 
                        'Already have an account? <span>Sign In</span>' :
                        "Don't have an account? <span>Sign Up</span>";
                };
            }
            
            if (authSubmit) {
                authSubmit.onclick = async () => {
                    const email = document.getElementById('authEmail').value;
                    const password = document.getElementById('authPassword').value;
                    
                    if (!email || !password) {
                        alert('Please enter both email and password');
                        return;
                    }
                    
                    try {
                        if (isSignUp) {
                            await firebase.auth().createUserWithEmailAndPassword(email, password);
                            console.log('✅ Sign up successful');
                        } else {
                            await firebase.auth().signInWithEmailAndPassword(email, password);
                            console.log('✅ Sign in successful');
                        }
                    } catch (error) {
                        console.error('❌ Auth error:', error);
                        alert('Authentication error: ' + error.message);
                    }
                };
            }
            
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.onclick = async () => {
                    try {
                        await firebase.auth().signOut();
                        console.log('✅ Logout successful');
                    } catch (error) {
                        console.error('❌ Logout error:', error);
                    }
                };
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function getDateRange(period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let startDate, endDate;
            
            switch(period) {
                case 'today':
                    startDate = today;
                    endDate = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                    break;
                case 'week':
                    const dayOfWeek = today.getDay();
                    startDate = new Date(today.getTime() - dayOfWeek * 24 * 60 * 60 * 1000);
                    endDate = new Date(startDate.getTime() + 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    break;
            }
            
            return { startDate, endDate };
        }
